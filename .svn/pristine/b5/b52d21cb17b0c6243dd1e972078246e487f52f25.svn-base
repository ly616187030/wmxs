<extend name="./Application/Admin/View/Public/layout.html"/>


<block name="style">
    <link href="__PUBLIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">
    <link href="__PUBLIC__/datetimepicker/css/dropdown.css" rel="stylesheet" type="text/css">
</block>

<block name="main">

    <div class="clearfix full-container">

        <div class="builder builder-list-box panel-body">

            <!-- Tab导航 -->
            <div class="cf form-group form-horizontal">

                <form id="search_form" action="{:U('Datastatistics/dailyData'),'',false}" method="get">
                    <input type="hidden" name="m" value="Datastatistics" />
                    <input type="hidden" name="c" value="Datastatistics" />
                    <input type="hidden" name="a" value="dailyData" />
                    <div class="form-group">
                        <div class="col-sm-3">
                            <label class="control-label col-sm-4">组织：</label>

                            <div class="col-sm-8">

                                <select class="form-control" name="restaurant">
                                    <volist name="_store" id="vo" key="k">
                                        <option value="{$vo.store_id}" <eq name="k" value="1">selected="selected"</eq> >{$vo.store_name}</option>
                                    </volist>
                                </select>

                            </div>
                        </div>

                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">配送员：</label>

                            <div class="col-sm-8">
                                <select class="form-control" name="person_id">
                                    <option value="">全部</option>
                                    <volist name="list_dp" id="vo">
                                        <option value="{$vo.person_id}"<eq name="vo.person_id" value="$person_id">selected="selected"</eq>>{$vo.person_name}</option>
                                    </volist>
                                </select>
                            </div>

                        </div>

                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">商家名称：</label>

                            <div class="col-sm-8">

                                <select class="form-control" name="store_id">
                                    <option value="">全部</option>
                                    <volist name="list_s" id="vo">
                                        <option value="{$vo.store_id}" <eq name="vo.store_id" value="$store_id">selected="selected"</eq>>{$vo.store_name}</option>
                                    </volist>
                                </select>

                            </div>

                        </div>

                    </div>

                    <div class="form-group">
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">支付方式：</label>

                            <div class="col-sm-8">
                                <select class="form-control" name="pay_type">
                                    <option value="">全部</option>
                                    <option value="0" <eq name="pay_type" value="0">selected="selected"</eq>>货到付款</option>
                                    <option value="1" <eq name="pay_type" value="1">selected="selected"</eq>>在线支付</option>
                                </select>
                            </div>

                        </div>
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">是否预订单：</label>

                            <div class="col-sm-8">

                                <select class="form-control" name="restaurant">
                                    <option value="">全部</option>
                                    <option value="1">是</option>
                                    <option value="0">否</option>
                                </select>

                            </div>

                        </div>
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">是否线下结算：</label>

                            <div class="col-sm-8">

                                <select class="form-control" name="">
                                    <option value="">全部</option>
                                    <option value="1">是</option>
                                    <option value="0">否</option>
                                </select>

                            </div>

                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">订单号：</label>

                            <div class="col-sm-8">

                                <input type="text" name="order_sn" class="form-control" value="{$order_sn}" />

                            </div>

                        </div>
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">运单状态：</label>

                            <div class="col-sm-8">

                                <select class="form-control" name="ord_peisong_status">
                                    <option value="">全部</option>
                                    <option value="0" <eq name="ord_peisong_status" value="0">selected="selected"</eq>>未分配</option>
                                    <option value="1" <eq name="ord_peisong_status" value="1">selected="selected"</eq>>已分配</option>
                                    <option value="2" <eq name="ord_peisong_status" value="2">selected="selected"</eq>>已接单</option>
                                    <option value="3" <eq name="ord_peisong_status" value="3">selected="selected"</eq>>已送餐</option>
                                    <option value="4" <eq name="ord_peisong_status" value="4">selected="selected"</eq>>已送达</option>
                                    <option value="5" <eq name="ord_peisong_status" value="5">selected="selected"</eq>>已取消</option>
                                </select>

                            </div>

                        </div>
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">配送评分：</label>

                            <div class="col-sm-8">

                                <select class="form-control">
                                    <option value="">全部</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>

                            </div>

                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">开始日期：</label>

                            <div class="col-sm-8">

                                <input type="text" name="stime" class="form-control date" <notempty name="stime">value="{$stime|date='Y-m-d',###}"</notempty> />

                            </div>

                        </div>
                        <div class="col-sm-3">

                            <label class="control-label col-sm-4">结束日期：</label>

                            <div class="col-sm-8">

                                <input type="text" name="etime" class="form-control date" <notempty name="etime">value="{$etime|date='Y-m-d',###}"</notempty> />

                            </div>

                        </div>

                    </div>
                    <div class="form-group">
                        <div class="col-sm-3">
                            <div class="col-sm-offset-1">
                                <button type="submit" class="btn btn-primary" id="search"><span class="glyphicon glyphicon-search"></span>查询</button>
                                <a href="{:U('excel')}"><button type="button" class="btn btn-primary">导出excel</button></a>
                            </div>
                        </div>

                    </div>

                </form>

            </div>

            <!-- 数据列表 -->
            <div class="builder-container builder-list-container">
                <div class="row">
                    <div class="col-xs-12">

                        <div class="builder-table">
                            <div class="panel panel-default">
                                <table class="table table-bordered table-responsive table-striped table-hover">
                                    <thead>
                                    <tr>
                                        <th>订单编号</th>
                                        <th>商家名称</th>
                                        <th>城市</th>
                                        <th>配送员</th>
                                        <th>商圈</th>
                                        <th>支付方式</th>
                                        <th>预订单</th>
                                        <th>线下结算</th>
                                        <th>配送评分</th>
                                        <th>运单状态</th>
                                        <th>订单金额</th>
                                        <th>付商家款</th>
                                        <th>收用户款</th>
                                        <th>配送费</th>
                                        <th>下单时间</th>
                                    </thead>
                                    <tbody>
                                    <notempty name="list_order">

                                        <volist name="list_order" id="vo">

                                            <tr>
                                                <td><a class="orderMore" data-id="{$vo.order_id}"  data-toggle="modal" data-target="#orderMore">{$vo.order_sn}</a> </td>
                                                <td>{$vo.store_name}</td>
                                                <td>{$vo.city_code|get_city_name='city',###}</td>
                                                <td>{$vo.person_name}</td>
                                                <td>{$vo.sq_name}</td>
                                                <td>
                                                    <eq name="vo.pay_type" value="0">货到付款</eq>
                                                    <eq name="vo.pay_type" value="1">在线支付</eq>
                                                </td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td>
                                                    <switch name="vo.ord_peisong_status">
                                                        <case value="0">未分配</case>
                                                        <case value="1">已分配</case>
                                                        <case value="2">已接单</case>
                                                        <case value="3">已送餐</case>
                                                        <case value="4">已送达</case>
                                                        <case value="5">已取消</case>
                                                    </switch>
                                                </td>
                                                <td>{$vo.total}</td>
                                                <td></td>
                                                <td></td>
                                                <td>{$vo.ps_cost}</td>
                                                <td>{$vo.xd_time|date="Y-m-d H:i:s",###}</td>
                                            </tr>

                                        </volist>

                                        <else/>

                                        <td colspan="15" class="text-center"> aOh! 暂时还没有内容!</td>

                                    </notempty>
                                    </tbody>
                                </table>
                            </div>
                            <div class="page">{$page}</div>
                        </div>

                    </div>
                </div>
            </div>


            <!-- 额外功能代码 -->
        </div>




    </div>


    <div class="modal fade bs-example-modal-lg" id="orderMore" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="orderMess">
            </div>
        </div>
    </div>
    <style>
        .page .current {height: auto;}
        .user-address ul{list-style: none;padding: 0;margin: 0;}
    </style>
</block>

<block name="script">
    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

    <script type="text/javascript">

            $('.orderMore').click(function(){
                var id = $(this).data('id');
                $.post('{:U("orderMore")}',{id:id}).success(function(data){
                    $(".modal-content").empty();
                    if (data != null) {
                        var temp = '';
                        if (data[0]['gender'] == 1) {
                            var sex = '先生';
                        } else {
                            var sex = '女士';
                        }
                        if (data[0]['pay_type'] == 0) {
                            var pay = '货到付款'
                        }
                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 1){
                            var pay = '已在线支付';
                        }
                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 0){
                            var pay = '未在线支付';
                        }
                        if (data[0]['order_message'] == '') {
                            var message = '无';
                        } else {
                            var message = data[0]['order_message'];
                        }
                        var ps_cost = parseInt(data[0]['ps_cost']);
                        var total = parseInt(data[0]['total']);
                        var yh_price = parseInt(data[0]['yh_price']);
                        var yajin = parseInt(data[0]['yajin']);
                        var canju_total = parseFloat(data[0]['canju_total']);
                        var yuan = parseFloat(data[0]['store_rebate']/100*total).toFixed(2);
                        var yongjin = parseFloat(total-yuan).toFixed(2);
                        var zongjia = parseFloat(ps_cost + total - yh_price + yajin + canju_total).toFixed(2);
                        var datetime = Trans_php_time_to_str(data[0]['send_time'],1);
                        temp += '<div style="width: 96%; border: 1px solid gainsboro; height: auto; border-radius: 5px; margin-left: 2%; margin-top: 2%; margin-bottom: 2%;">'
                        + '<div style="border-bottom: 1px solid gainsboro; width: 100%; margin-top: 10px; padding-bottom: 10px;">'
                        + '<span style="margin-left: 2%;">订单号：</span><span>' + data[0]['order_sn'] + '</span>' + '</div>' + '<div style="width: 52%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">商家信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>商家名称：<span>' + data[0]['store_name'] + '</span></li>' + '<li>商家地址：<span>' + data[0]['address_detail'] + '</span></li>' + '<li>商家电话：<span>' + data[0]['tel'] + '</span></li>'
                        + '<li>取货应付：<span style="color: red;">￥' + total + '</span>' + '<span style="margin-left: 2%;">实付：<span style="color: green;">￥' + yongjin + '</span><span style="margin-left: 2%">佣金:&nbsp;'+yuan+'</span></span>'
                        +'<li>押金：￥<span>'+data[0]['yajin']+'</span></li>'
                        +'<li>配送费：￥<span>'+data[0]['ps_cost']+'</span></li>'
                        + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="width: 48%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">顾客信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>顾客地址：<span>' + data[0]['detail_address'] + '</span></li>' + '<li>顾客电话：<span>' + data[0]['phone'] + '</span></li>' + '<li>顾客姓名：<span>' + data[0]['username'] + '(' + sex + ')</span></li>'
                        +'<li><span>期望送达时间:&nbsp;</span><span>'+datetime+'</span></li>'
                        +'<li><span>租用器具:&nbsp;</span><span>'+data[0]['qiju_quantity']+'</span></li>'
                        +'<li><span>用餐人数:&nbsp;</span><span>'+data[0]['people_num']+'</span></li>'
                        + '<li>应收金额：<span style="color: red;">￥' + zongjia + '(' + pay + ')</span>' + '<span style="margin-left: 2%;">实收：<span style="color: green;">￥' + zongjia + '</span></span>' + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="clear: both;"></div>' + '<div style="height:100px;width: 100%;"></div>' + '<div style="border-radius: 5px; border: 1px solid gainsboro; margin-top: 10px; padding-top: 10px;">' + '<div style="border-bottom: 1px solid gainsboro;width: 100%;">' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px;">订单明细</div>' + '</div>' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px; color: #149b52;">' + '<span>备注：</span><span>' + message + '</span>' + '<br />' + '<span>开票信息：</span><span>无</span>' + '</div>' + '<div style="overflow:auto; height:220px;">' + '<table style="border-radius: 5px; margin-left: 2%; width: 95.5%;margin-bottom: 50px;" class="table-striped table-bordered table-hover">' + '<thead>' + '<tr>' + '<td>商品名称</td>' + '<td>数量</td>' + '<td>单价(元)</td>' + '<td>应收顾客(元)</td>' + '</tr>' + '</thead>' + '<tbody class="canming">' + '</tbody>' + '</table>' + '</div>' + '</div>'
                        $('#orderMess').html(temp);
                        var cm = '';
                        for (var a in data[0]['child']) {
                            cm += '<tr>' + '<td>' + data[0]['child'][a]['cm_name'] + '</td>' + '<td>' + data[0]['child'][a]['quantity'] + '</td>' + '<td>' + data[0]['child'][a]['price'] + '</td>' + '<td>' + data[0]['child'][a]['total_money'] + '</td>' + '</tr>'
                        }
                        $('.canming').html(cm);
                    }



                });
            });
            function Trans_php_time_to_str(timestamp,n){

                var update = new Date(timestamp*1000);//戳要乘1000

                var year   = update.getFullYear();

                var month  = (update.getMonth()+1<10)?('0'+(update.getMonth()+1)):(update.getMonth()+1);

                var day    = (update.getDate()<10)?('0'+update.getDate()):(update.getDate());

                var hour   = (update.getHours()<10)?('0'+update.getHours()):(update.getHours());

                var minute = (update.getMinutes()<10)?('0'+update.getMinutes()):(update.getMinutes());

                var second = (update.getSeconds()<10)?('0'+update.getSeconds()):(update.getSeconds());

                if(n==1){

                    return (year+'-'+month+'-'+day+' '+hour+':'+minute);

                }else if(n==2){

                    return (year+'-'+month+'-'+day);

                }else{

                    return 0;

                }

            }
            $('.date').datetimepicker({

                format: 'yyyy-mm-dd',

                language:"zh-CN",

                minView:2,

                autoclose:true

            });

            highlight_subnav('{:U("Datastatistics/dailyData")}');
    </script>

</block>



