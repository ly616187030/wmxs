<?php/** * 店铺分类数据库 * 数据库表名 wm_store_category * store_c_id      店铺分类ID * store_c_name    店铺分类名称 * city_id         所属城市ID * sort_order      排序 * flag            标记(1启用，0未启用) */namespace Business\Controller;use Admin\Controller\AdminController;class PingjiaController extends AdminController{    public function index(){        $id = session('store_id');        $store_name = session('store_name'); //从session取店铺名称        if($id !=''){           $pj = M('pingjia');            $count = $pj->where('store_id='.$id)->count();// 查询满足要求的总记录数            $Page = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数(15)            $Page->setConfig('header','<span class="rows">共 %TOTAL_ROW% 条记录</span>');            $Page->setConfig('first','首页');            $Page->setConfig('prev','上一页');            $Page->setConfig('next','下一页');            $Page->setConfig('last','末页');            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END% ');            $Page->lastSuffix = false;//分页最后的总页数不显示            $show = $Page->show();// 分页显示输出            $this->assign('page',$show);// 赋值分页输出           $content = $pj->alias('a')->join('LEFT JOIN wm_member as b ON a.uid = b.uid')->where('store_id='.$id)->field('a.*,b.nickname')->limit($Page->firstRow.','.$Page->listRows)->order('a.pj_time desc')->select();            $this->assign('list',$content);            $this->meta_title = '评价管理';        }else{           $date = '您还没有选择店铺，请先点击右上角选择店铺';           $this->assign('ab',$date);        }        $m = M('Store');        $uid = session('user_auth.uid');        if(is_administrator($uid)){            $list_store = $m->select();        }else{            $list_ra = $m->where('uid = '.$uid)->getField('store_id',true);            if(!empty($list_ra)){                $store_where['store_id'] = array('in',$list_ra);                $list_store = $m->where($store_where)->select();            }        }        $this->assign('list_store',$list_store);        $this->assign('name',$store_name);        $this->display();    }    public function add(){        if(IS_POST){            $array = array(                array('store_id','require','请选择商家！'),                array('uid','require','请选择用户！'),                array('pingfen','require','请选择评分！'),                array('content','require','请输入评价内容！')            );            $pingjia = M('pingjia');            $pj_time = I('pj_time');            if($pingjia->validate($array)->create()){                $pingjia->pj_time = strtotime($pj_time);                 if($pingjia->add()){                     $this->success('新增成功',U('index'));                 }else{                     $this->error('新增失败');                 }            }else{                $this->error($pingjia->getError());            }        }else{            $id = session('store_id');  //从session取店铺ID            $store_name = session('store_name'); //从session取店铺名称            $store = M('store')->field('store_name,store_id')->select();            $this->assign('store',$store);            $this->assign('name',$store_name);            $this->assign('id',$id);            $this->display();        }    }    public function del(){        $id = array_unique((array)I('pj_id',0));        $map = array('pj_id' => array('in', $id) );        if(M('pingjia')->where($map)->delete()){            $this->success('删除成功');        }else{            $this->error('删除失败！');        }    }    public function option(){        $option = I('option');        $user =M('member')->where('user_type ='.$option)->field('uid,nickname')->select();        $this->ajaxReturn($user);    }}