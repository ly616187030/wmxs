<extend name="./Application/Admin/View/Public/layout.html"/><block name="style">    <style>        body{            margin:30px;        }    </style></block><block name="main">	<div class="cf" style="margin-bottom: 10px;">        <button class="btn btn-success ajax-post confirm" url="{:U('batch_audit')}" target-form="ids">批量审核</button>		<audio id="audio" src="__PUBLIC__/audio.mp3"  preload="metadata"></audio>		<button type="button" class="btn btn-danger" id="stop">停止响铃</button>	</div>	<div class="data-table table-striped">	<form class="ids">		<table class="table">			<thead>				<tr>					<th class="row-selected">						<input class="checkbox check-all" type="checkbox" style="visibility: hidden">					</th>					<th>订单ID</th>					<th>订单编号</th>                    <th>所属店铺</th>                    <th>支付方式</th>					<th>商家距离（米）</th>                    <th>下单时间</th>                    <th>期望送达时间</th>					<th>操作</th>				</tr>			</thead>			<tbody>				<notempty name="list">				<volist name="list" id="_data">					<tr id="ord_{$_data.order_id}">						<td>							<input id="biaoji" class="ids row-selected" type="checkbox" data-uid="{$_data.push_msg_id}" name="order_id[]" value="{$_data.order_id}">							<input type="hidden" name="pushid[]"  />						</td>						<td>{$_data.order_id}</td>						<td>                            <a class="orderMore" data-id="{$_data.order_id}"  data-toggle="modal" data-target="#orderMore">{$_data.order_sn}</a>                        </td>						<td>{$_data.store_name}</td>                        <td>                            <eq name="_data.pay_type" value="1">                                <eq name="_data.is_paied" value="0">                                    在线支付<span style="color: #FF0000">(未付款)</span>                                </eq>                                <eq name="_data.is_paied" value="1">                                    在线支付<span style="color: #FF0000">(已付款)</span>                                </eq>                            </eq>                            <eq name="_data.pay_type" value="0">货到付款</eq>                        </td>						<td>                            <if condition="$_data.is_peisong eq true">                                {$_data.distance_number}（在配送范围内）                               <else />                                {$_data.distance_number}（不在配送范围内）                            </if>                        </td>						<td>{$_data.xd_time|date='Y-m-d H:i:s',###}</td>                        <td>{$_data.send_time|date='Y-m-d H:i:s',###}</td>						<td>                            <a id="stop_audio" data-ordid="{$_data.order_id}" data-pushid="{$_data.push_msg_id}"  href="javascript:void(0)" >                                审核                            </a>                            <a class="cancel" data-ordid="{$_data.order_id}" data-type="{$_data.status}" data-paied="{$_data.is_paied}" data-toggle="modal" data-target="#cannel" >                                拒单                            </a>                        </td>					</tr>				</volist>				<else/>				<td colspan="10" class="text-center"> aOh! 暂时还没有内容! </td>				</notempty>			</tbody>		</table>	 </form>		<!-- 分页 -->	    <div class="page">	        {$page}	    </div>	</div><!--订单详情-->    <div class="modal fade bs-example-modal-lg" id="orderMore" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">        <div class="modal-dialog modal-lg" role="document">            <div class="modal-content" id="orderMess">            </div>        </div>    </div>    <!--拒单-->    <div class="modal fade" id="cannel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">        <div class="modal-dialog" role="document">            <div class="modal-content">                <div class="modal-header" id="aa">                    <h4 class="modal-title">拒单原因</h4>                </div>                <form action="{:U('cancelOrder')}" method="post">                    <div class="modal-body">                        <div class="form-group">                            <input type="hidden" value="" name="order_id" />                            <input type="hidden" value="" name="type">                            <input type="hidden" value="" name="paied">                            <textarea class="form-control" name="content" rows="3"></textarea>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn" id="submit" type="submit" target-form="form-horizontal">确 定</button>                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                    </div>                </form>            </div>        </div>    </div><block name="script">	<script src='__PUBLIC__/socket.io.js'></script>	<script type="text/javascript">        //初始化连接服务器		$(document).ready(function () {			var uid='{:session("user_auth.push_msg_id")}';			// 连接服务端			//var socket = io('http://zhg.zhuyousoft.com:2120');            var socket = io('http://'+document.domain+':2120');			// 连接后登录			socket.on('connect', function(){				socket.emit('login', uid);			});			// 后端推送来消息时			socket.on('new_msg', function(msg){				//$('#content').html('收到消息：'+msg);				msg=='success' && location.reload();			});			// 后端推送来在线数据时			socket.on('update_online_count', function(online_stat){			 $('#online_box').html(online_stat);			 });			$("input[type='checkbox']").click(function(){				var $this=$(this);				if($this.is(':checked')){					$this.next().val($this.data('uid'));				}else{					$this.next().val('');				}			});			var music=document.getElementById('audio');			var stop=document.getElementById('stop');			var timer=setInterval(function(){				music.play();			},2000)			stop.onclick=function(){				music.pause();				clearInterval(timer);			}            //拒单点击            $('.cancel').click(function(){                var id = $(this).data('ordid');                var type = $(this).data('type');                var paied = $(this).data('paied');                $('input[name="order_id"]').val(id);                $('input[name="type"]').val(type);                $('input[name="paied"]').val(paied);            });            //订单详情查看            $('.orderMore').click(function(){                var id = $(this).data('id');                $('#orderM').empty();                $.post("{:U('orderMore')}",{order_id:id}).success(function(data){                    if (data != null) {                        var temp = '';                        if (data[0]['gender'] == 1) {                            var sex = '先生';                        } else {                            var sex = '女士';                        }                        if (data[0]['pay_type'] == 0) {                            var pay = '货到付款'                        }                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 1){                            var pay = '已在线支付';                        }                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 0){                            var pay = '未在线支付';                        }                        if (data[0]['order_message'] == '') {                            var message = '无';                        } else {                            var message = data[0]['order_message'];                        }                        var ps_cost = parseInt(data[0]['ps_cost']);                        var total = parseInt(data[0]['total']);                        var yh_price = parseInt(data[0]['yh_price']);                        var yajin = parseInt(data[0]['yajin']);                        var canju_total = parseFloat(data[0]['canju_total']);                        var yuan = parseFloat(data[0]['store_rebate']/100*total).toFixed(2);                        var yongjin = total-yuan;                        var zongjia = ps_cost + total - yh_price + yajin + canju_total;                        var datetime = Trans_php_time_to_str(data[0]['send_time'],1);                        temp += '<div style="width: 96%; border: 1px solid gainsboro; height: auto; border-radius: 5px; margin-left: 2%; margin-top: 2%; margin-bottom: 2%;">'                        + '<div style="border-bottom: 1px solid gainsboro; width: 100%; margin-top: 10px; padding-bottom: 10px;">'                        + '<span style="margin-left: 2%;">订单号：</span><span>' + data[0]['order_sn'] + '</span>' + '</div>' + '<div style="width: 52%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">商家信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>商家名称：<span>' + data[0]['store_name'] + '</span></li>' + '<li>商家地址：<span>' + data[0]['address_detail'] + '</span></li>' + '<li>商家电话：<span>' + data[0]['tel'] + '</span></li>'                        + '<li>取货应付：<span style="color: red;">￥' + total + '</span>' + '<span style="margin-left: 2%;">实付：<span style="color: green;">￥' + yongjin + '</span><span style="margin-left: 2%">佣金:&nbsp;'+yuan+'</span></span>'                        +'<li>押金：￥<span>'+data[0]['yajin']+'</span></li>'                        +'<li>配送费：￥<span>'+data[0]['ps_cost']+'</span></li>'                        + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="width: 48%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">顾客信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>顾客地址：<span>' + data[0]['detail_address'] + '</span></li>' + '<li>顾客电话：<span>' + data[0]['ph'] + '</span></li>' + '<li>顾客姓名：<span>' + data[0]['username'] + '(' + sex + ')</span></li>'                        +'<li><span>期望送达时间:&nbsp;</span><span>'+datetime+'</span></li>'                        +'<li><span>租用器具:&nbsp;</span><span>'+data[0]['qiju_quantity']+'</span></li>'                        +'<li><span>用餐人数:&nbsp;</span><span>'+data[0]['people_num']+'</span></li>'                        + '<li>应收金额：<span style="color: red;">￥' + zongjia + '(' + pay + ')</span>' + '<span style="margin-left: 2%;">实收：<span style="color: green;">￥' + zongjia + '</span></span>' + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="clear: both;"></div>' + '<div style="height:100px;width: 100%;"></div>' + '<div style="border-radius: 5px; border: 1px solid gainsboro; margin-top: 10px; padding-top: 10px;">' + '<div style="border-bottom: 1px solid gainsboro;width: 100%;">' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px;">订单明细</div>' + '</div>' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px; color: darkgray;">' + '<span>备注：</span><span>' + message + '</span>' + '<br />' + '<span>开票信息：</span><span>无</span>' + '</div>' + '<div style="overflow:auto; height:220px;">' + '<table style="border-radius: 5px; margin-left: 2%; width: 95.5%;margin-bottom: 50px;" class="table-striped table-bordered table-hover">' + '<thead>' + '<tr>' + '<td>商品名称</td>' + '<td>数量</td>' + '<td>单价(元)</td>' + '<td>应收顾客(元)</td>' + '</tr>' + '</thead>' + '<tbody class="canming">' + '</tbody>' + '</table>' + '</div>' + '</div>'                        $('.modal-content').html(temp);                        var cm = '';                        for (var a in data[0]['child']) {                            cm += '<tr>' + '<td>' + data[0]['child'][a]['cm_name'] + '</td>' + '<td>' + data[0]['child'][a]['quantity'] + '</td>' + '<td>' + data[0]['child'][a]['price'] + '</td>' + '<td>' + data[0]['child'][a]['total_money'] + '</td>' + '</tr>'                        }                        $('.canming').html(cm);                    }                });            });            //num表示要四舍五入的数,v表示要保留的小数位数。            function decimal(num,v)            {                var vv = Math.pow(10,v);                return Math.round(num*vv)/vv;            }            //时间转换            function Trans_php_time_to_str(timestamp,n){                var update = new Date(timestamp*1000);//戳要乘1000                var year   = update.getFullYear();                var month  = (update.getMonth()+1<10)?('0'+(update.getMonth()+1)):(update.getMonth()+1);                var day    = (update.getDate()<10)?('0'+update.getDate()):(update.getDate());                var hour   = (update.getHours()<10)?('0'+update.getHours()):(update.getHours());                var minute = (update.getMinutes()<10)?('0'+update.getMinutes()):(update.getMinutes());                var second = (update.getSeconds()<10)?('0'+update.getSeconds()):(update.getSeconds());                if(n==1){                    return (year+'-'+month+'-'+day+' '+hour+':'+minute);                }else if(n==2){                    return (year+'-'+month+'-'+day);                }else{                    return 0;                }            }            //拒单提交            $('form').submit(function(){                var self = $(this);                $.post(self.attr("action"), self.serialize(), function(data){                    if(data>0){                        $('div.alert').show().text('拒单成功');                        $('div.alert').addClass('alert-success');                        setTimeout(function(){                            $('div.alert-success').slideUp('slow');                            $('#cannel').modal('hide');                            $('#cannel').on('hidden.bs.modal', function (e) {                                window.location.reload();                            })                        },1500);                    }else{                        $('div.alert').show().text(data.info);                        setTimeout(function(){                            $('div.alert').slideUp('slow');                        },1500);                    }                }, "json");                return false;            });            //接单提交			$('#stop_audio').click(function(){				$('#stop').trigger('click');				var $this=$(this);				var ordid=$this.data('ordid');				var pushid=$this.data('pushid');				$.get('{:U("batch_audit")}','order_id='+ordid+'&pushid='+pushid).success(function(){					$('#ord_'+ordid).hide();				});			});		});</script></block>