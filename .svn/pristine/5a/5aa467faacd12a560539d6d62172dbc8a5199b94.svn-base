<?php/** * Created by PhpStorm. * Auther: <zhangpf41@163.com> * Date: 2015/6/26 * Time: 17:40 */namespace Home\Controller;use Think\Model;class OrderController extends HomeController{    /**     * 确认下单,保存订单基本信息     */    public function doOrder(){        $posts=I("post.");        $checktoggle=C('CHECKTOGGLE');        if($checktoggle==0){            $where['store_id']=$posts['storeid'];            $pushid=M('Store')->where($where)->getField('push_msg_id',true);        }elseif($checktoggle==1){            $pushid=C('DIAODU_PUSHID');        }        $data['uid']=UID;        $snn=$this->buildOrderSn();        $data['order_sn']=$snn;        $data['store_id']=$posts['storeid'];        $data['ps_cost']=$posts['yunfei'];        $data['sh_mode']=$posts['shmode'];        $data['send_time']=$posts['dinnertime'];        $data['order_message'] = $posts['remark'];        $data['address_id']=$posts['addressid'];        $data['total'] = $posts['total'];        $data['people_num'] = $posts['personnum'];        $data['pay_type'] = $posts['paytype'];        $data['yajin'] = $posts['deposit'];        $data['xd_time']=time();        $data['yh_price']=$posts['yh_price'];        $data['canju_total']=$posts['canjutotal'];        $data['status']=$posts['paytype']==0?3:1;        $data['check_status']=$checktoggle==0?1:0;        $data['qiju_quantity']=$posts['qiju_quantity'];        $data['from_operation']=3;        $data['juan_id']=empty($posts['juan_id']) && 0;        $data['juan_price']=$posts['juan_price'];        $data['cuxiao_id']=$posts['cuxiao_id'];        $model= new Model();        $model->startTrans();        $flag=false;        $goods_count=0;        $orderid=$model->table(C('DB_PREFIX').'order')->add($data);                //添加数据进收藏店铺表        $map['uid']=$data['uid'];        $map['store_id']=$data['store_id'];        $map['status']=1;        $sc['uid']=$data['uid'];        $sc['store_id']=$data['store_id'];        $sc['status']=1;        if(!empty($orderid)){            //$this->ajaxReturn(array('info'=>$orderid,'status'=>1));            $data1=A('Cart')->cartView();            $num=count($data1[0]);            $temp=array();            foreach($data1[0] as $v){                $temp[]=array("order_id"=>$orderid,"cm_id"=>$data1[0][$v],"price"=>$data1[2][$v],"quantity"=>$data1[3][$v],"total_money"=>$data1[2][$v]*$data1[3][$v],"xd_time"=>time());                $n = $this->updateGoodsSale($model, $posts['storeid'], $data1[0][$v], $data1[3][$v]);                $goods_count+=(int)$n;            }            $orderlist=$model->table(C('DB_PREFIX').'order_detail')->addAll($temp);            //$ordertemp=$model->table(C('DB_PREFIX').'order_temp')->add(array("order_id"=>$orderid,"store_id"=>$posts['store_id'],"sh_mode"=>$posts['sh_mode']));            !empty($data['juan_id']) && M('user_bao')->where('user_bao_id='.$data['juan_id'])->setField('status',1);            if(!empty($orderlist) && $goods_count==$num){                push_msg_client($pushid);                $model->commit();                $flag=true;            }else{                $this->ajaxReturn(array("status"=>0,"info"=>$model->getError()));            }            if(!$flag){                $model->rollback();            }            $shoucang = M('favorites_store')->where($map)->find();            if(empty($shoucang)){                M('favorites_store')->add($sc);            }           $this->ajaxReturn(array("status"=>$flag,"ordsn"=>$snn));        }else{            $this->error($model->getError());        }    }    /**     * 获取手机号     */    public function getPhone($address_id){        $res=M("UserAddress")->where("address_id=".$address_id)->getField('phone');        return $res;    }    /**     * 生成唯一订单编号     */    private function buildOrderSn(){        $res= date('YmdHis').substr(implode(NULL, array_map('ord', str_split(substr(uniqid(), 7, 13), 1))), 0, 8);        /*$map['order_sn']=$res;        $data_sn=M("Order")->where($map)->find();        if(empty($data_sn)){            return $res;        }else if($res==$data_sn){            $this->buildOrderSn();        }*/        return $res;    }    //插入或更新销量    public function updateGoodsSale(&$model, $store_id, $cm_id, $num)    {        $data['store_id'] = $store_id;        $map['cm_id']=$data['cm_id']=$cm_id;        $map['month']=$data['month']=(int)date("n",time());        $map['year']=$data['year']=(int)date("Y",time());        $data['quantity']=$num;        $res=$model->table('wm_goods_count')->where($map)->find();        if(empty($res)){            $res1=$model->table('wm_goods_count')->add($data);            if(!empty($res1)){                return 1;            }else{                return 0;            }        }else{            $res2=$model->table('wm_goods_count')->where($map)->setInc('quantity',$num);            if($res2!==false){                return 1;            }else{                return 0;            }        }    }}