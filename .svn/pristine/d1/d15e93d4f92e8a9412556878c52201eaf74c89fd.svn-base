<?php// +----------------------------------------------------------------------// | OneThink [ WE CAN DO IT JUST THINK IT ]// +----------------------------------------------------------------------// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.// +----------------------------------------------------------------------// | Author: 麦当苗儿 <zuojiazi@vip.qq.com> <http://www.zjzit.cn>// +----------------------------------------------------------------------/** * 前台公共库文件 * 主要定义前台公共函数库 *//** * 检测验证码 * @param  integer $id 验证码ID * @return boolean     检测结果 * @author 麦当苗儿 <zuojiazi@vip.qq.com> */function check_verify($code, $id = 1){	$verify = new \Think\Verify();	return $verify->check($code, $id);}/** * 获取列表总行数 * @param  string  $category 分类ID * @param  integer $status   数据状态 * @author 麦当苗儿 <zuojiazi@vip.qq.com> */function get_list_count($category, $status = 1){    static $count;    if(!isset($count[$category])){        $count[$category] = D('Document')->listCount($category, $status);    }    return $count[$category];}/** * 获取段落总数 * @param  string $id 文档ID * @return integer    段落总数 * @author 麦当苗儿 <zuojiazi@vip.qq.com> */function get_part_count($id){    static $count;    if(!isset($count[$id])){        $count[$id] = D('Document')->partCount($id);    }    return $count[$id];}/** * 获取导航URL * @param  string $url 导航URL * @return string      解析或的url * @author 麦当苗儿 <zuojiazi@vip.qq.com> */function get_nav_url($url){    switch ($url) {        case 'http://' === substr($url, 0, 7):        case '#' === substr($url, 0, 1):            break;                default:            $url = U($url);            break;    }    return $url;}/** * 通过配送员id 获得配送员名称 * @param $id */function get_psy_name($id){    return M("delivery_person")->getFieldByStoreId($id,'person_name');}/** * 通过配送员id 获得配送员电话 * @param $id */function get_psy_phone($id){    return M("delivery_person")->getFieldByStoreId($id,'phone');}/** * 计算两个坐标之间的距离(米) *  @param float $fP1Lon 起点(经度) * @param float $fP1Lat 起点(纬度) * @param float $fP2Lon 终点(经度) * @param float $fP2Lat 终点(纬度) * @return int */function distanceBetween( $fP1Lon,$fP1Lat,$fP2Lon,$fP2Lat){    $fEARTH_RADIUS = 6378137;    //角度换算成弧度    $fRadLon1 = deg2rad($fP1Lon);    $fRadLon2 = deg2rad($fP2Lon);    $fRadLat1 = deg2rad($fP1Lat);    $fRadLat2 = deg2rad($fP2Lat);    //计算经纬度的差值    $fD1 = abs($fRadLat1 - $fRadLat2);    $fD2 = abs($fRadLon1 - $fRadLon2);    //距离计算    $fP = pow(sin($fD1/2), 2) + cos($fRadLat1) * cos($fRadLat2) * pow(sin($fD2/2), 2);    return intval($fEARTH_RADIUS * 2 * asin(sqrt($fP)) + 0.5);}/** * 百度坐标系转换成标准GPS坐系 * @param float $lnglat 坐标(如:106.426, 29.553404) * @return string 转换后的标准GPS值: *//*function BD09LLtoWGS84($fLng, $fLat){ // 经度,纬度    $lnglat = explode(',', $lnglat);    list($x,$y) = $lnglat;    $Baidu_Server = "http://api.map.baidu.com/ag/coord/convert?from=0&to=4&x={$x}&y={$y}";    $result = @file_get_contents($Baidu_Server);    $json = json_decode($result);    if($json->error == 0){        $bx = base64_decode($json->x);        $by = base64_decode($json->y);        $GPS_x = 2 * $x - $bx;        $GPS_y = 2 * $y - $by;        return $GPS_x.','.$GPS_y;//经度,纬度    }else        return $lnglat;}*//** * 判断餐厅是否在营业中 * @param $start string 营业开始时间 * @param $end string 营业结束时间 * @return boolean true=营业 false=暂停 */function is_open($start,$end){    $curstamp=strtotime(date("G:i",time()));    if(!empty($start) && !empty($end)){        $s=explode(',',$start);        $szao="$s[0]:$s[1]";        $swan="$s[2]:$s[3]";        $e=explode(',',$end);        $ezao="$e[0]:$e[1]";        $ewan="$e[2]:$e[3]";    }else if(!empty($start) && empty($end)){        $s=explode(',',$start);        $szao="$s[0]:$s[1]";        $swan="$s[2]:$s[3]";        $ewan=$ezao=0;    }    if(($curstamp>strtotime($szao) && $curstamp<strtotime($swan)) ||        ($curstamp>strtotime($ezao) && $curstamp<strtotime($ewan))){        return 1;    }else{        return 0;    }}/** * @param $times 营业时间字符串 * @param int $num 数组索引 * @return mixed */function yingye_to_time($times,$num=0){    if(strpos($times,",")) {        $list = explode(",", $times);        return $list[$num];    }else{        return $times;    }}/** * 营业时间是否为2个 * @param $times * @return bool */function yingye_is_two($times){    if(strpos($times,",")){        return true;    }else{        return false;    }}//检查是否是手机/*function is_mobile(){    // 如果有HTTP_X_WAP_PROFILE则一定是移动设备    if (isset ($_SERVER['HTTP_X_WAP_PROFILE'])) {        return true;    }    // 如果via信息含有wap则一定是移动设备,部分服务商会屏蔽该信息    if (isset ($_SERVER['HTTP_VIA'])) {        // 找不到为flase,否则为true        return stristr($_SERVER['HTTP_VIA'], "wap") ? true : false;    }    // 脑残法，判断手机发送的客户端标志,兼容性有待提高    if (isset ($_SERVER['HTTP_USER_AGENT'])) {        $clientkeywords = array ('nokia',            'sony',            'ericsson',            'mot',            'samsung',            'htc',            'sgh',            'lg',            'sharp',            'sie-',            'philips',            'panasonic',            'alcatel',            'lenovo',            'iphone',            'ipod',            'blackberry',            'meizu',            'android',            'netfront',            'symbian',            'ucweb',            'windowsce',            'palm',            'operamini',            'operamobi',            'openwave',            'nexusone',            'cldc',            'midp',            'wap',            'mobile'        );        // 从HTTP_USER_AGENT中查找手机浏览器的关键字        if (preg_match("/(" . implode('|', $clientkeywords) . ")/i", strtolower($_SERVER['HTTP_USER_AGENT']))) {            return true;        }    }    // 协议法，因为有可能不准确，放到最后判断    if (isset ($_SERVER['HTTP_ACCEPT'])) {        // 如果只支持wml并且不支持html那一定是移动设备        // 如果支持wml和html但是wml在html之前则是移动设备        if ((strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') !== false) && (strpos($_SERVER['HTTP_ACCEPT'], 'text/html') === false || (strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') < strpos($_SERVER['HTTP_ACCEPT'], 'text/html'))))        {            return true;        }    }    return false;}*//** * 通过商家id 获得商家信息 * @param $id */function get_store_name($id){    return M("store")->getFieldBystore_id($id,'store_name');}/** * 通过商家id 获得点餐人信息 * @param $id */function get_user_address($id){    return M("user_address")->getFieldByaddress_id($id,'username');}function get_address($id){    return M("user_address")->getFieldByaddress_id($id,'detail_address');}function get_user_phone($id){    return M("user_address")->getFieldByaddress_id($id,'phone');}/** * 通过商家id 获得点餐人信息 * @param $id */function get_canpin_name($id){    return M("canpin")->getFieldBycanpin_id($id,'canpin_name');}/** * 判断一个坐标在不在指定坐标集范围 * @param  string $lng $lat 当前坐标 经 纬 * @param  array $st_poly 范围坐标集 * @return boolean     true-表示$pt坐标在$poly坐标范围，false-表示不在范围 */function HPointInPoly($lng,$lat,$st_poly){    $pt['x'] = $lng;    $pt['y'] = $lat;    $ress= explode(",",$st_poly);    for($i=0;$i<count($ress);$i+=2){        $arr_text1['x'] = $ress[$i];        $arr_text1['y'] = $ress[$i+1];        $poly[] = $arr_text1;    }    for ($c = false, $i = -1, $l = count($poly), $j = $l - 1; ++$i < $l; $j = $i){        if((($poly[$i]['y'] <= $pt['y'] && $pt['y'] < $poly[$j]['y']) || ($poly[$j]['y'] <= $pt['y'] && $pt['y'] < $poly[$i]['y']))&& ($pt['x'] < ($poly[$j]['x'] - $poly[$i]['x']) * ($pt['y'] - $poly[$i]['y']) / ($poly[$j]['y'] - $poly[$i]['y']) + $poly[$i]['x'])){            $c = !$c;        }    }    return $c;}