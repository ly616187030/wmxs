<?php if (!defined('THINK_PATH')) exit();?><!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title><?php echo ($meta_title); ?>｜<?php echo C('WEB_SITE_TITLE');?>后台管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="author" content="<?php echo C('WEB_SITE_TITLE');?>">
    <meta name="keywords" content="<?php echo ($meta_keywords); ?>">
    <meta name="description" content="<?php echo ($meta_description); ?>">
    <meta name="generator" content="CoreThink">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="<?php echo C('WEB_SITE_TITLE');?>">
    <meta name="format-detection" content="telephone=no,email=no">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <link rel="apple-touch-icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/Public/libs/cui/css/cui.min.css">
    <link rel="stylesheet" type="text/css" href="/./Application/Admin/View/Public/css/admin.css?v=<?php echo C('STATIC_VERSION');?>">
    <link rel="stylesheet" type="text/css" href="/./Application/Admin/View/Public/css/theme/<?php echo C('ADMIN_THEME');?>.css">
    <link rel="stylesheet" type="text/css" href="/Public/libs/cui/css/page.css">
    <link rel="stylesheet" type="text/css" href="/Public/libs/cui/css/cui.extend.min.css">
        <style>        body{            padding:20px;            font-family: "Microsoft Yahei";        }        table thead tr th {            text-align: left;        }    </style>
    <!--[if lt IE 9]>
        <script src="http://cdn.bootcss.com/html5shiv/r29/html5.min.js"></script>
        <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- 如果配置里CDN静态资源列表则使用CDN否则使用静态资源 -->
    <?php if(C('CDN_RESOURCE_LIST')): ?>
        <?php echo C('CDN_RESOURCE_LIST');?>
    <?php else: ?>
        <script type="text/javascript" src="/Public/libs/jquery/1.x/jquery.min.js"></script>

    <?php endif; ?>
    <!--<script type="text/javascript" src="/Public/common.js"></script>-->
</head>

<body>
    <div class="clearfix full-header">
        
    </div>

    <div class="clearfix full-container">

            <div class="m-b">        <form class="form-inline" action="<?php echo U('Order/refund');?>" method="post">            <div class="form-group">                <label  for="exampleInputEmail3">查询日期：</label>                <input type="text" class="form-control date" id="exampleInputEmail3" name="keywords" placeholder="输入日期" value="<?php echo ($keyword); ?>">                <button class="btn btn-success" type="submit">查询</button>            </div>        </form>    </div>    <div class="data-table">        <table class="table">            <!-- 表头 -->            <thead>            <tr>                <th>订单编号</th>                <th>配送方式</th>                <th>支付方式</th>                <th>金额(元)</th>                <th>订单状态</th>                <th>操作</th>            </tr>            </thead>            <!-- 列表 -->            <tbody>            <?php if(!empty($list)): if(is_array($list)): $i = 0; $__LIST__ = $list;if( count($__LIST__)==0 ) : echo "" ;else: foreach($__LIST__ as $key=>$vo): $mod = ($i % 2 );++$i;?><tr>                        <td><?php echo ($vo["order_sn"]); ?></td>                        <?php if($vo["sh_mode"] == 0): ?><td>自己配送</td><?php else: ?><td>平台配送</td><?php endif; ?>                        <?php if($vo["pay_type"] == 0): ?><td>货到付款</td><?php else: ?><td>在线支付<?php if($vo["is_paied"] == 1): ?><strong style="color:red;">(已付款)</strong><?php else: ?><strong style="color:red;">(待付款)</strong><?php endif; ?></td><?php endif; ?>                        <td><?php echo ($vo['total_fee']/100); ?></td>                        <td>                            <?php switch($vo["status"]): case "8": ?><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="取消订单时间：<?php echo (date('Y-m-d H:i:s',$vo["cancel_ord_time"])); ?>取消订单原因：<?php echo ($vo["cancel_ord_reason"]); ?>" >取消订单</a><?php break;?>                                <?php case "10": ?><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="拒接订单时间：<?php echo (date('Y-m-d H:i:s',$vo["reject_time"])); ?>拒接订单原因：<?php echo ($vo["reject_reason"]); ?>">拒接订单</a><?php break;?>                                <?php case "11": ?><span>退款中</span><?php break;?>                                <?php case "12": ?><span>退款完成</span><?php break;?>                                <?php case "13": ?><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="取消订单时间：<?php echo (date('Y-m-d H:i:s',$vo["cancel_ord_time"])); ?>拒接订单原因：<?php echo ($vo["cancel_ord_reason"]); ?>">取消订单</a><?php break;?>                                <?php case "15": ?><span>退款中</span><?php break;?>                                <?php case "16": ?><span>退款中</span><?php break;?>                                <?php case "17": ?><span>退款完成</span><?php break; endswitch;?>                        </td>                        <td><?php if(($vo["is_paied"] == 1) AND (($vo["status"] == 8) OR ($vo["status"] == 10) OR ($vo["status"] == 13))): ?><a class="refund" href="javascript:void(0)" data-status="<?php echo ($vo["status"]); ?>" data-transaction_id="<?php echo ($vo["transaction_id"]); ?>" data-order_sn="<?php echo ($vo["order_sn"]); ?>" data-total_fee="<?php echo ($vo["total_fee"]); ?>" data-refund_fee="<?php echo ($vo["total_fee"]); ?>">申请退款</a>                            <?php elseif(($vo["status"] == 11) OR ($vo["status"] == 15) OR ($vo["status"] == 16)): ?><a data-transaction_id="<?php echo ($vo["transaction_id"]); ?>"  data-status="<?php echo ($vo["status"]); ?>" data-order_sn="<?php echo ($vo["order_sn"]); ?>" href="javascript:;" class="refund_search">退款查询</a><?php else: ?>无<?php endif; ?>                        </td>                    </tr><?php endforeach; endif; else: echo "" ;endif; ?>                <?php else: ?>                <?php if(empty($pd_dp)): ?><td colspan="17" class="text-center"> aOh! 暂时还没有内容! </td>                    <?php else: ?>                    <td colspan="17" class="text-center"><?php echo ($pd_dp); ?></td><?php endif; endif; ?>            </tbody>        </table>    </div>    <!-- 分页 -->    <div class="page">        <?php echo ($page); ?>    </div>    <div class="modal fade" id="myModal">        <div class="modal-dialog">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                    <h4 class="modal-title"></h4>                </div>                <div class="modal-body">                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                </div>            </div><!-- /.modal-content -->        </div><!-- /.modal-dialog -->    </div><!-- /.modal -->    <div id="alert_tip" style="background: rgba(0,0,0,.6);position: absolute;top:35%;left:50%;z-index:9999;font-size:1.2em;padding:10px 20px;color:#fff;border-radius: 5px;font-weight:bold;display: none;">接单成功！</div>
    </div>

    <div class="clearfix full-footer">
        
    </div>

    <div class="clearfix full-script">
        <div class="container-fluid">
            <input type="hidden" id="corethink_home_img" value="/./Application/Home/View/Public/img">
            <script type="text/javascript" src="/Public/libs/cui/js/cui.min.js"></script>
            <script type="text/javascript" src="/./Application/Admin/View/Public/js/admin.js?v=<?php echo C('STATIC_VERSION');?>"></script>
            <script type="text/javascript" src="/Public/libs/cui/js/cui.extend.min.js"></script>
                <link href="/Public/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">    <script type="text/javascript" src="/Public/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>    <script type="text/javascript" src="/Public/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>    <script type="text/javascript">        $(function () {            $('[data-toggle="popover"]').popover();            $('.date').datetimepicker({                format: 'yyyy-mm-dd',                language:"zh-CN",                minView:2,                autoclose:true            });        })        //退款操作        $(".refund").click(function(){            var $this=$(this);            var transaction_id=$this.data('transaction_id');            var total_fee=$this.data('total_fee');            var refund_fee=$this.data('refund_fee');            var ordsn=$this.data('order_sn');            var status=$this.data('status');            var url="<?php echo U('Order/refund');?>";            var modal=$("#myModal");            var out_refund_no=(''+Math.random() * 10).substr(2);            if(confirm('你确定要申请退款吗？退款金额为：'+refund_fee)){                $.post("payinterface/request.php",{transaction_id:transaction_id,total_fee:total_fee,refund_fee:refund_fee,out_refund_no:out_refund_no,method:'submitRefund'}).success(function(data){                    //console.log(data);                    var dd=$.parseJSON(data);                    if(dd.status=='200'){                        $.get("<?php echo U('Order/modifyRefundStatus');?>",'order_sn='+ordsn+'&status='+status).success(function(res){                            if(res){                                modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="font-size:1.5em;">'+dd.msg+'</strong>');                                setTimeout(function(){                                    modal.modal('hide');                                    location.reload();                                },3000);                            }                        });                    }else if(dd.status=='500'){                        modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">'+dd.msg+'</strong>');                        setTimeout(function(){modal.modal('hide')},3000);                    }                });            }        });        //退款查询        $('.refund_search').click(function(){            var $this=$(this);            var transaction_id=$this.data('transaction_id');            var status=$this.data('status');            var ordsn=$this.data('order_sn');            var modal=$("#myModal");            $.ajax({                url: 'payinterface/request.php',                type: 'POST',                dataType: 'json',                timeout:20000,                data:{method:'queryRefund',transaction_id:transaction_id},                beforeSend:function(){                    $('#alert_tip').show().text('信息加载中...');                },                success:function(res){                    if(typeof(res) === 'string'){                        res = JSON.parse(res);                    }                    if(res.status==200){                        var refund_res=res.data;                        if(refund_res.refund_status_0=='SUCCESS'){                            $.get("<?php echo U('Order/modifyRefundStatus');?>",'order_sn='+ordsn+'&status='+status).success(function(res){                                if(res){                                    modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="font-size:1.5em;">退款成功</strong>');                                    setTimeout(function(){                                        modal.modal('hide');                                        location.reload();                                    },3000);                                }                            });                        }else if(refund_res.refund_status_0=='PROCESSING'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">退款中</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='FIAL'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">退款失败</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='NOTSURE'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">未确定， 需要商户原退款单号重新发起</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='CHANGE'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">转入代发，退款到 银行发现用户的卡作废或者冻结了，导致原路退款银行 卡失败，资金回流到商户的 现金帐号，需要商户人工干 预，通过线下或者威富通转 账的方式进行退款。 </strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }                    }else if(res.status==500){                        modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">'+res.msg+'</strong>');                        setTimeout(function(){modal.modal('hide')},3000);                    }                },                complete:function(){                    $('#alert_tip').hide();                }            });        });        //展示订单详情        $(".detail").click(function(){            var $this=$(this);            var ordid=$this.data('orderid');            $.get('<?php echo U("getOrderDetail");?>','ordid='+ordid).success(function(data){                if(data!=null){                    var list=data;                    var str='<table class="table table-bordered"><thead><tr><th>菜品名称</th><th>单价</th><th>数量</th><th>金额</th></tr></thead><tbody>';                    for(var i= 0,ln=list.length;i<ln;i++){                        str+='<tr><td>'+list[i].cm_name+'</td><td>'+list[i].price+'</td><td>'+list[i].quantity+'</td><td>'+list[i].total_money+'</td></tr>';                    }                    str+='</tbody></table><div><strong>姓名：'+list[0].username+'</strong>/<strong>电话：'+list[0].phone+'</strong>/<strong>详细地址：'+list[0].detail_address+'</strong>';                    $('#myModal').modal('show').find('.modal-title').text('订单详情').end().find('.modal-body').html(str).end().find('.modal-footer').html('<button class="btn btn-default" data-dismiss="modal" aria-label="Close">关闭</button>');                }else{                    $('#myModal').modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').text('暂无详情');                }            });        });    </script>
        </div>
    </div>
</body>
</html>