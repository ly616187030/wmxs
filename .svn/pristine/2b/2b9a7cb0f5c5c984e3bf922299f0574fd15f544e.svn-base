<extend name="./Application/Admin/View/Public/layout.html"/><block name="style">    <link href="__PUBLIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">    <style>        body{            margin:30px;        }        .cf{            margin-bottom: 30px;        }    </style></block><block name="main">    <!-- 高级搜索 -->    <div class="search-form cf">            <div class="row">                <div class="col-md-1">                    <label>查询类型</label>                    <select class="form-control input-sm" id="id_cxlx" data-cxlx="{$cxlx}">                        <option value="1">店铺名称</option>                    </select>                </div>                <div class="col-md-2" style="margin-left: -10px">                    <label>店铺选择</label>                    <select class="form-control input-sm" id="id_cxtj" data-cxtj="{$cxtj}">                        <option value="0">请选择店铺</option>                        <volist name="store_name_list" id="vo">                            <option value="{$vo.store_id}">{$vo.store_name}</option>                        </volist>                    </select>                </div>                <div class="col-md-2" style="margin-left: -10px">                    <label>订单状态</label>                    <select class="form-control input-sm" id="id_ddzt" data-ddzt="{$ddzt}">                        <option value="0">全部</option>                        <option value="1">未支付订单</option>                        <option value="2">已支付订单</option>                        <option value="3">餐到付款</option>                        <option value="4">商家已确认</option>                        <option value="7">未付款已拒单</option>                        <option value="10">在线支付已拒单</option>                        <option value="9">餐到付款已拒单</option>                        <option value="13">商家已确认拒单</option>                    </select>                </div>                <div class="col-md-2" style="margin-left: -10px">                    <label >时间类型</label>                    <select class="form-control input-sm" id="id_sjlx" data-sjlx="{$sjlx}">                        <option value="1">送达时间</option>                        <option value="2">下单时间</option>                    </select>                </div>                <div class="col-md-3" style="margin-left: -40px">                    <label >&nbsp;</label>                    <div class="form-group">                        <label class="col-sm-1" style="margin-top: 5px">从</label>                        <div class="col-sm-6" style="margin-left: -10px">                            <input class="form-control input-sm date" type="text" placeholder="起始查询时间" id="id_qsrq" readonly="value" value="{$qssj}">                        </div>                    </div>                </div>                <div class="col-md-3" style="margin-left: -160px" >                    <label >&nbsp;</label>                    <div class="form-group">                        <label class="col-sm-1" style="margin-top: 5px;">到</label>                        <div class="col-sm-6" style="margin-left: -10px">                            <input class="form-control input-sm date" type="text" placeholder="结束查询时间" id="id_jsrq" readonly="value" value="{$jssj}">                        </div>                    </div>                    <button type="button" id="search" url="{:U('history')}" class="btn btn-info" style="margin-top: -25px;margin-left: 10px">搜索</button>                </div>            </div>    </div>	<div class="data-table table-striped">	<form class="ids">		<table class="table">			<thead>				<tr>					<th class="row-selected">						<input class="checkbox check-all" type="checkbox" style="visibility: hidden">					</th>					<th>订单ID</th>					<th>订单编号</th>					<th>所属店铺</th>                    <th>支付方式</th>					<th>商家距离（米）</th>                    <th>下单时间</th>                    <th>期望送达时间</th>                    <th>状态</th>					<th>操作</th>				</tr>			</thead>			<tbody>				<notempty name="list">				<volist name="list" id="_data">					<tr id="ord_{$_data.order_id}">						<td>							<input id="biaoji" class="ids row-selected" type="checkbox" data-uid="{$_data.push_msg_id}" name="order_id[]" value="{$_data.order_id}">							<input type="hidden" name="pushid[]"  />						</td>						<td>{$_data.order_id}</td>						<td>                            <a class="orderMore" data-id="{$_data.order_id}"  data-toggle="modal" data-target="#orderMore1">{$_data.order_sn}</a>                        </td>						<td>{$_data.store_name}</td>                        <td>                            <if condition="$_data.pay_type eq 0">                                货到付款                                <else/>                                在线支付<if condition="$_data.is_paied eq 1">(<span style="color:red;">已付款</span>)<else/>(<span style="color:red;">未支付</span>)</if>                            </if>                        </td>						<td>                            <if condition="$_data.is_peisong eq true">                                {$_data.distance_number}（在配送范围内）                               <else />                                {$_data.distance_number}（不在配送范围内）                            </if>                        </td>						<td>{$_data.xd_time|date='Y-m-d H:i:s',###}</td>                        <td>{$_data.send_time|date='Y-m-d H:i:s',###}</td>                        <td>                            <switch name="_data.status">                                <case value="1">未支付订单</case>                                <case value="2">已支付订单</case>                                <case value="3">餐到付款</case>                                <case value="4">商家已确认</case>                                <case value="5">完成订单</case>                                <case value="6">完成评价</case>                                <case value="7">取消订单</case>                                <case value="8">取消已付款订单</case>                                <case value="9">商家拒单（用户货到付款）</case>                                <case value="10">商家拒单（用户在线支付后，商家拒单，转到退款）</case>                                <case value="11">退款中</case>                                <case value="12">退款完成</case>                                <case value="13">用户下单，商家接单，后用户取消订单</case>                                <case value="14">制作完成</case>                                <case value="15">退款中</case>                                <case value="16">退款中</case>                                <case value="17">退款完成</case>                                <case value="18">退款完成</case>                                <default/>default                            </switch>                        </td>						<td>                            <if condition="($_data.status neq 9) && ($_data.status neq 10)">                                <a class="cancel" data-ordid="{$_data.order_id}" data-type="{$_data.status}" data-paied="{$_data.is_paied}" data-toggle="modal" data-target="#cannel1" >                                    拒单                                </a>                                <else />                                    已拒单                            </if>                            <a href="{:U('del?order_id='.$_data['order_id'])}" class="confirm ajax-get" >删除</a>                        </td>					</tr>				</volist>				<else/>				<td colspan="10" class="text-center"> aOh! 暂时还没有内容! </td>				</notempty>			</tbody>		</table>	 </form>		<!-- 分页 -->	    <div class="page">	        {$page}	    </div>	</div><!--订单详情-->    <div class="modal fade bs-example-modal-lg" id="orderMore1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">        <div class="modal-dialog modal-lg" role="document">            <div class="modal-content" id="orderMess">            </div>        </div>    </div>    <!--拒单-->    <div class="modal fade" id="cannel1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">        <div class="modal-dialog" role="document">            <div class="modal-content">                <div class="modal-header" id="aa">                    <h4 class="modal-title">拒单原因</h4>                </div>                <form action="{:U('cancelOrder')}" method="post">                    <div class="modal-body">                        <div class="form-group">                            <input type="hidden" value="" name="order_id" />                            <input type="hidden" value="" name="type">                            <input type="hidden" value="" name="paied">                            <textarea class="form-control" name="content" rows="3"></textarea>                        </div>                    </div>                    <div class="modal-footer">                        <button class="btn" id="submit" type="submit" target-form="form-horizontal">确 定</button>                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                    </div>                </form>            </div>        </div>    </div><block name="script">    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>	<script type="text/javascript">        //初始化连接服务器		$(document).ready(function () {            var cxlx = $('#id_cxlx').data('cxlx');            var ddzt = $('#id_ddzt').data('ddzt');            var sjlx = $('#id_sjlx').data('sjlx');            var cxtj = $('#id_cxtj').data('cxtj');            if(cxlx > 0){                $("#id_cxlx option[value="+cxlx+"]").attr("selected", "selected");            }            if(ddzt > 0){                $("#id_ddzt option[value="+ddzt+"]").attr("selected", "selected");            }            if(sjlx > 0){                $("#id_sjlx option[value="+sjlx+"]").attr("selected", "selected");            }            if(sjlx > 0){                $("#id_cxtj option[value="+cxtj+"]").attr("selected", "selected");            }            //初始化时间            $('.date').datetimepicker({                format: 'yyyy-mm-dd',                language:"zh-CN",                minView:2,                autoclose:true            });            //搜索功能            $("#search").click(function(){                var url = $(this).attr('url');    //当前地址                var cxlx  = $('#id_cxlx').val();  //查询类型                var cxtj  = $('#id_cxtj').val();  //查询条件                var ddzt  = $('#id_ddzt').val();  //订单状态                var sjlx  = $('#id_sjlx').val();  //时间类型                var qssj  = $('#id_qsrq').val();  //起始时间                var jssj  = $('#id_jsrq').val();  //结束时间                var qssj_arr = qssj.split("-");                var qssj_time = new Date(qssj_arr[0],qssj_arr[1],qssj_arr[2]).getTime()/1000;                var jssj_arr = jssj.split("-");                var jssj_time = new Date(jssj_arr[0],jssj_arr[1],jssj_arr[2]).getTime()/1000;                if(jssj_time < qssj_time){                    $('#top-alert').find('div').text('起始时间不能大于结束时间');                    $('#top-alert').show();                    setTimeout(function(){                        $('#top-alert').find('div').text('');                        $('#top-alert').hide();                    },1500);                    return;                }                if( url.indexOf('?')>0){                    url += '&cxlx=' + cxlx;                }else{                    url += '?cxlx=' + cxlx;                }                url += '&cxtj=' + cxtj;                url += '&ddzt=' + ddzt;                url += '&sjlx=' + sjlx;                url += '&qssj=' + qssj;                url += '&jssj=' + jssj;                url += '&tj=888';                window.location.href = url;            });            //拒单点击            $('.cancel').click(function(){                var id = $(this).data('ordid');                var type = $(this).data('type');                var paied = $(this).data('paied');                $('input[name="order_id"]').val(id);                $('input[name="type"]').val(type);                $('input[name="paied"]').val(paied);            });            //订单详情查看            $('.orderMore').click(function(){                var id = $(this).data('id');                $('#orderM').empty();                $.post("{:U('orderMore')}",{order_id:id}).success(function(data){                    if (data != null) {                        var temp = '';                        if (data[0]['gender'] == 1) {                            var sex = '先生';                        } else {                            var sex = '女士';                        }                        if (data[0]['pay_type'] == 0) {                            var pay = '货到付款'                        }                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 1){                            var pay = '已在线支付';                        }                        if(data[0]['pay_type'] == 1 && data[0]['is_paied'] == 0){                            var pay = '未在线支付';                        }                        if (data[0]['order_message'] == '') {                            var message = '无';                        } else {                            var message = data[0]['order_message'];                        }                        var ps_cost = parseInt(data[0]['ps_cost']);                        var total = parseInt(data[0]['total']);                        var yh_price = parseInt(data[0]['yh_price']);                        var yajin = parseInt(data[0]['yajin']);                        var canju_total = parseFloat(data[0]['canju_total']);                        var yuan = parseFloat(data[0]['store_rebate']/100*total).toFixed(2);                        var yongjin = total-yuan;                        var zongjia = ps_cost + total - yh_price + yajin + canju_total;                        var datetime = Trans_php_time_to_str(data[0]['send_time'],1);                        temp += '<div style="width: 96%; border: 1px solid gainsboro; height: auto; border-radius: 5px; margin-left: 2%; margin-top: 2%; margin-bottom: 2%;">'                        + '<div style="border-bottom: 1px solid gainsboro; width: 100%; margin-top: 10px; padding-bottom: 10px;">'                        + '<span style="margin-left: 2%;">订单号：</span><span>' + data[0]['order_sn'] + '</span>' + '</div>' + '<div style="width: 52%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">商家信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>商家名称：<span>' + data[0]['store_name'] + '</span></li>' + '<li>商家地址：<span>' + data[0]['address_detail'] + '</span></li>' + '<li>商家电话：<span>' + data[0]['tel'] + '</span></li>'                        + '<li>取货应付：<span style="color: red;">￥' + total + '</span>' + '<span style="margin-left: 2%;">实付：<span style="color: green;">￥' + yongjin + '</span><span style="margin-left: 2%">佣金:&nbsp;'+yuan+'</span></span>'                        +'<li>押金：￥<span>'+data[0]['yajin']+'</span></li>'                        +'<li>配送费：￥<span>'+data[0]['ps_cost']+'</span></li>'                        + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="width: 48%; height: 118px;float: left;">' + '<div style="margin-left: 2%; padding-top: 1%;">顾客信息</div>' + '<div style="margin-left: 4%;">' + '<ul>' + '<li>顾客地址：<span>' + data[0]['detail_address'] + '</span></li>' + '<li>顾客电话：<span>' + data[0]['ph'] + '</span></li>' + '<li>顾客姓名：<span>' + data[0]['username'] + '(' + sex + ')</span></li>'                        +'<li><span>期望送达时间:&nbsp;</span><span>'+datetime+'</span></li>'                        +'<li><span>租用器具:&nbsp;</span><span>'+data[0]['qiju_quantity']+'</span></li>'                        +'<li><span>用餐人数:&nbsp;</span><span>'+data[0]['people_num']+'</span></li>'                        + '<li>应收金额：<span style="color: red;">￥' + zongjia + '(' + pay + ')</span>' + '<span style="margin-left: 2%;">实收：<span style="color: green;">￥' + zongjia + '</span></span>' + '</li>' + '</ul>' + '</div>' + '</div>' + '<div style="clear: both;"></div>' + '<div style="height:100px;width: 100%;"></div>' + '<div style="border-radius: 5px; border: 1px solid gainsboro; margin-top: 10px; padding-top: 10px;">' + '<div style="border-bottom: 1px solid gainsboro;width: 100%;">' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px;">订单明细</div>' + '</div>' + '<div style=" padding-top: 10px; margin-left: 2%; padding-bottom: 10px; color: darkgray;">' + '<span>备注：</span><span>' + message + '</span>' + '<br />' + '<span>开票信息：</span><span>无</span>' + '</div>' + '<div style="overflow:auto; height:220px;">' + '<table style="border-radius: 5px; margin-left: 2%; width: 95.5%;margin-bottom: 50px;" class="table-striped table-bordered table-hover">' + '<thead>' + '<tr>' + '<td>商品名称</td>' + '<td>数量</td>' + '<td>单价(元)</td>' + '<td>应收顾客(元)</td>' + '</tr>' + '</thead>' + '<tbody class="canming">' + '</tbody>' + '</table>' + '</div>' + '</div>'                        $('#orderMess').html(temp);                        var cm = '';                        for (var a in data[0]['child']) {                            cm += '<tr>' + '<td>' + data[0]['child'][a]['cm_name'] + '</td>' + '<td>' + data[0]['child'][a]['quantity'] + '</td>' + '<td>' + data[0]['child'][a]['price'] + '</td>' + '<td>' + data[0]['child'][a]['total_money'] + '</td>' + '</tr>'                        }                        $('.canming').html(cm);                    }                });            });            //num表示要四舍五入的数,v表示要保留的小数位数。            function decimal(num,v)            {                var vv = Math.pow(10,v);                return Math.round(num*vv)/vv;            }            //时间转换            function Trans_php_time_to_str(timestamp,n){                var update = new Date(timestamp*1000);//戳要乘1000                var year   = update.getFullYear();                var month  = (update.getMonth()+1<10)?('0'+(update.getMonth()+1)):(update.getMonth()+1);                var day    = (update.getDate()<10)?('0'+update.getDate()):(update.getDate());                var hour   = (update.getHours()<10)?('0'+update.getHours()):(update.getHours());                var minute = (update.getMinutes()<10)?('0'+update.getMinutes()):(update.getMinutes());                var second = (update.getSeconds()<10)?('0'+update.getSeconds()):(update.getSeconds());                if(n==1){                    return (year+'-'+month+'-'+day+' '+hour+':'+minute);                }else if(n==2){                    return (year+'-'+month+'-'+day);                }else{                    return 0;                }            }            //拒单提交            $('form').submit(function(){                var self = $(this);                $.post(self.attr("action"), self.serialize(), function(data){                    if(data>0){                        $('div.alert').show().text('拒单成功');                        $('div.alert').addClass('alert-success');                        setTimeout(function(){                            $('div.alert-success').slideUp('slow');                            $('#cannel').modal('hide');                            $('#cannel').on('hidden.bs.modal', function (e) {                                window.location.reload();                            })                        },1500);                    }else{                        $('div.alert').show().text(data.info);                        setTimeout(function(){                            $('div.alert').slideUp('slow');                        },1500);                    }                }, "json");                return false;            });            //接单提交			$('#stop_audio').click(function(){				$('#stop').trigger('click');				var $this=$(this);				var ordid=$this.data('ordid');				var pushid=$this.data('pushid');                alert("aa");				$.get('{:U("batch_audit")}','order_id='+ordid+'&pushid='+pushid).success(function(){					$('#ord_'+ordid).hide();				});			});		});</script></block>