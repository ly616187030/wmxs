<extend name="./Application/Admin/View/Public/layout.html"/><block name="style">    <style>        body{            padding:20px;            font-family: "Microsoft Yahei";        }        table thead tr th {            text-align: left;        }    </style></block><block name="main">    <div class="m-b">        <form class="form-inline" action="{:U('Order/refund')}" method="post">            <div class="form-group">                <label  for="exampleInputEmail3">查询日期：</label>                <input type="text" class="form-control date" id="exampleInputEmail3" name="keywords" placeholder="输入日期" value="{$keyword}">                <button class="btn btn-success" type="submit">查询</button>            </div>        </form>    </div>    <div class="data-table">        <table class="table">            <!-- 表头 -->            <thead>            <tr>                <th>订单编号</th>                <th>配送方式</th>                <th>支付方式</th>                <th>金额(元)</th>                <th>订单状态</th>                <th>操作</th>            </tr>            </thead>            <!-- 列表 -->            <tbody>            <notempty name="list">                <volist name="list" id="vo">                    <tr>                        <td>{$vo.order_sn}</td>                        <if condition="$vo.sh_mode eq 0"><td>自己配送</td><else/><td>平台配送</td></if>                        <if condition="$vo.pay_type eq 0"><td>货到付款</td><else/><td>在线支付<if condition="$vo.is_paied eq 1"><strong style="color:red;">(已付款)</strong><else/><strong style="color:red;">(待付款)</strong></if></td></if>                        <td>{$vo['total_fee']/100}</td>                        <td>                            <switch name="vo.status">                                <case value="8"><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="取消订单时间：{$vo.cancel_ord_time|date='Y-m-d H:i:s',###}取消订单原因：{$vo.cancel_ord_reason}" >取消订单</a></case>                                <case value="10"><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="拒接订单时间：{$vo.reject_time|date='Y-m-d H:i:s',###}拒接订单原因：{$vo.reject_reason}">拒接订单</a></case>                                <case value="11"><span>退款中</span></case>                                <case value="12"><span>退款完成</span></case>                                <case value="13"><a href="javascript:;" data-toggle="popover" data-container="body" data-placement="left" data-content="取消订单时间：{$vo.cancel_ord_time|date='Y-m-d H:i:s',###}拒接订单原因：{$vo.cancel_ord_reason}">取消订单</a></case>                                <case value="15"><span>退款中</span></case>                                <case value="16"><span>退款中</span></case>                                <case value="17"><span>退款完成</span></case>                            </switch>                        </td>                        <td><if condition="($vo.is_paied eq 1) AND (($vo.status eq 8) OR ($vo.status eq 10) OR ($vo.status eq 13))"><a class="refund" href="javascript:void(0)" data-status="{$vo.status}" data-transaction_id="{$vo.transaction_id}" data-order_sn="{$vo.order_sn}" data-total_fee="{$vo.total_fee}" data-refund_fee="{$vo.total_fee}">申请退款</a>                            <elseif condition="($vo.status eq 11) OR ($vo.status eq 15) OR ($vo.status eq 16)"/><a data-transaction_id="{$vo.transaction_id}"  data-status="{$vo.status}" data-order_sn="{$vo.order_sn}" href="javascript:;" class="refund_search">退款查询</a><else/>无                        </if>                        </td>                    </tr>                </volist>                <else/>                <empty name="pd_dp">                    <td colspan="17" class="text-center"> aOh! 暂时还没有内容! </td>                    <else />                    <td colspan="17" class="text-center">{$pd_dp}</td>                </empty>            </notempty>            </tbody>        </table>    </div>    <!-- 分页 -->    <div class="page">        {$page}    </div>    <div class="modal fade" id="myModal">        <div class="modal-dialog">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                    <h4 class="modal-title"></h4>                </div>                <div class="modal-body">                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                </div>            </div><!-- /.modal-content -->        </div><!-- /.modal-dialog -->    </div><!-- /.modal -->    <div id="alert_tip" style="background: rgba(0,0,0,.6);position: absolute;top:35%;left:50%;z-index:9999;font-size:1.2em;padding:10px 20px;color:#fff;border-radius: 5px;font-weight:bold;display: none;">接单成功！</div></block><block name="script">    <link href="__PUBLIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>    <script type="text/javascript" src="__PUBLIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>    <script type="text/javascript">        $(function () {            $('[data-toggle="popover"]').popover();            $('.date').datetimepicker({                format: 'yyyy-mm-dd',                language:"zh-CN",                minView:2,                autoclose:true            });        })        //退款操作        $(".refund").click(function(){            var $this=$(this);            var transaction_id=$this.data('transaction_id');            var total_fee=$this.data('total_fee');            var refund_fee=$this.data('refund_fee');            var ordsn=$this.data('order_sn');            var status=$this.data('status');            var url="{:U('Order/refund')}";            var modal=$("#myModal");            var out_refund_no=(''+Math.random() * 10).substr(2);            if(confirm('你确定要申请退款吗？退款金额为：'+refund_fee)){                $.post("payinterface/request.php",{transaction_id:transaction_id,total_fee:total_fee,refund_fee:refund_fee,out_refund_no:out_refund_no,method:'submitRefund'}).success(function(data){                    //console.log(data);                    var dd=$.parseJSON(data);                    if(dd.status=='200'){                        $.get("{:U('Order/modifyRefundStatus')}",'order_sn='+ordsn+'&status='+status).success(function(res){                            if(res){                                modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="font-size:1.5em;">'+dd.msg+'</strong>');                                setTimeout(function(){                                    modal.modal('hide');                                    location.reload();                                },3000);                            }                        });                    }else if(dd.status=='500'){                        modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">'+dd.msg+'</strong>');                        setTimeout(function(){modal.modal('hide')},3000);                    }                });            }        });        //退款查询        $('.refund_search').click(function(){            var $this=$(this);            var transaction_id=$this.data('transaction_id');            var status=$this.data('status');            var ordsn=$this.data('order_sn');            var modal=$("#myModal");            $.ajax({                url: 'payinterface/request.php',                type: 'POST',                dataType: 'json',                timeout:20000,                data:{method:'queryRefund',transaction_id:transaction_id},                beforeSend:function(){                    $('#alert_tip').show().text('信息加载中...');                },                success:function(res){                    if(typeof(res) === 'string'){                        res = JSON.parse(res);                    }                    if(res.status==200){                        var refund_res=res.data;                        if(refund_res.refund_status_0=='SUCCESS'){                            $.get("{:U('Order/modifyRefundStatus')}",'order_sn='+ordsn+'&status='+status).success(function(res){                                if(res){                                    modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="font-size:1.5em;">退款成功</strong>');                                    setTimeout(function(){                                        modal.modal('hide');                                        location.reload();                                    },3000);                                }                            });                        }else if(refund_res.refund_status_0=='PROCESSING'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">退款中</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='FIAL'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">退款失败</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='NOTSURE'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">未确定， 需要商户原退款单号重新发起</strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }else if(refund_res.refund_status_0=='CHANGE'){                            modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">转入代发，退款到 银行发现用户的卡作废或者冻结了，导致原路退款银行 卡失败，资金回流到商户的 现金帐号，需要商户人工干 预，通过线下或者威富通转 账的方式进行退款。 </strong>');                            setTimeout(function(){modal.modal('hide')},3000);                        }                    }else if(res.status==500){                        modal.modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').html('<strong style="color:red;font-size:1.5em;">'+res.msg+'</strong>');                        setTimeout(function(){modal.modal('hide')},3000);                    }                },                complete:function(){                    $('#alert_tip').hide();                }            });        });        //展示订单详情        $(".detail").click(function(){            var $this=$(this);            var ordid=$this.data('orderid');            $.get('{:U("getOrderDetail")}','ordid='+ordid).success(function(data){                if(data!=null){                    var list=data;                    var str='<table class="table table-bordered"><thead><tr><th>菜品名称</th><th>单价</th><th>数量</th><th>金额</th></tr></thead><tbody>';                    for(var i= 0,ln=list.length;i<ln;i++){                        str+='<tr><td>'+list[i].cm_name+'</td><td>'+list[i].price+'</td><td>'+list[i].quantity+'</td><td>'+list[i].total_money+'</td></tr>';                    }                    str+='</tbody></table><div><strong>姓名：'+list[0].username+'</strong>/<strong>电话：'+list[0].phone+'</strong>/<strong>详细地址：'+list[0].detail_address+'</strong>';                    $('#myModal').modal('show').find('.modal-title').text('订单详情').end().find('.modal-body').html(str).end().find('.modal-footer').html('<button class="btn btn-default" data-dismiss="modal" aria-label="Close">关闭</button>');                }else{                    $('#myModal').modal('show').find('.modal-title').text('提示信息').end().find('.modal-body').text('暂无详情');                }            });        });    </script></block>