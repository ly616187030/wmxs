<?php// +----------------------------------------------------------------------// | OneThink [ WE CAN DO IT JUST THINK IT ]// +----------------------------------------------------------------------// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.// +----------------------------------------------------------------------// | Author: 麦当苗儿 <zuojiazi@vip.qq.com> <http://www.zjzit.cn>// +----------------------------------------------------------------------namespace Home\Controller;/** * 前台首页控制器 * 主要获取首页聚合数据 */class IndexController extends HomeController {	//外卖首页    public function index() {        Cookie('__forward__', C('HOME_PAGE'));        if (C('INDEX_URL')) {            if (stristr(C('INDEX_URL'), 'http://') || stristr(C('INDEX_URL'), 'https://')) {                redirect(C('INDEX_URL'));            } else {                $this->redirect(C('INDEX_URL'));            }        }        $this->assign('meta_title', "首页");        $this->display();    }    public function index2(){        $type=I('get.type');        if (empty($type)) {            $url=cookie();            if(!empty($url['restaurant_url'])){                redirect($url['restaurant_url']);            }        }        if(UID){            $this->assign('is_login',true);        }        $city=M('City');        $ct= $city            ->join("LEFT JOIN wm_address_city ON wm_address_city.code = wm_city.city_code")            ->field("wm_address_city.name")            ->select();        foreach($ct as $k=>$v){            $ct[$k]['name'] = str_replace('市','',$v['name']);        }        $this->assign('ct',$ct);        $ctcode= $city            ->join("LEFT JOIN wm_address_city ON wm_address_city.code = wm_city.city_code")            ->field("wm_city.city_id,wm_address_city.code")            ->select();        $this->assign('ctcode',$ctcode);        $this->assign('meta_title','助友外卖');        $this->display();    }    //外卖主页    public function waimai(){        $this->index();    }    //获取商圈地址列表    public function getShangquan(){        $code=I('get.code');        if(!empty($code)){            $map['city_code']=$code;            $sq=M('Shangquan')->where($map)->order('sort')->select();            if(!empty($sq)){                foreach($sq as $vv){                    $id[]=$vv['sq_id'];                }                $ids=implode(",",$id);                $map1['sq_id']=array('in',$ids);                $scope=M('RestaurantScope')->where($map1)->order('sort_order')->select();                foreach($sq as $key=>$val){                    foreach($scope as $v){                        if($v['sq_id']===$val['sq_id']){                            $sq[$key]['childs'][]=$v;                        }                    }                }                $this->ajaxReturn($sq);            }else{                $this->ajaxReturn(null);            }        }else{            $this->ajaxReturn(null);        }    }    //获取代理城市    public function getDaili(){        $daili=M('City')->alias('d')->join('wm_address_city AS a ON d.city_code=a.code')->field('a.*')->select();        $data=array();        $one=array('title'=>'ABCDE');$two=array('title'=>'FGHIJ');$three=array('title'=>'KLMNO');$four=array('title'=>'PQRST');$five=array('title'=>'UVWXYZ');        foreach($daili as $v) {            if (preg_match('/' . $v['first_name'] . '/', $one['title'])) {                $one['child'][] = $v;            } elseif (preg_match('/' . $v['first_name'] . '/', $two['title'])) {                $two['child'][] = $v;            } elseif (preg_match('/' . $v['first_name'] . '/', $three['title'])) {                $three['child'][] = $v;            } elseif (preg_match('/' . $v['first_name'] . '/', $four['title'])) {                $four['child'][] = $v;            } elseif (preg_match('/' . $v['first_name'] . '/', $five['title'])) {                $five['child'][] = $v;            }        }        $data[] = $one;        $data[] = $two;        $data[] = $three;        $data[] = $four;        $data[] = $five;        //dump($data);        $this->ajaxReturn($data);    }    //获得城市代码    public function getCityCode(){        $cityname=I('get.cityname');        $map['cityname']=array('like',"%".$cityname."%");        $code=M("City")->where($map)->find();        $this->ajaxReturn($code);    }}