<?php/** * 城市管理数据库 * 数据库表名 wm_city * city_id      城市ID * city_name    城市名称 * help_code    快捷字母 * sort_order   排序 * flag         标记(1启用，0未启用) */namespace Administration\Controller;use Admin\Controller\AdminController;class SalesManagemenController extends AdminController{	//初始化    public function index(){		$User = M('store'); // 实例化User对象		$count      = $User->count();// 查询满足要求的总记录数		$Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数(25)		$Page->setConfig('header','<span class="rows">共 %TOTAL_ROW% 条记录</span>');        $Page->setConfig('first','首页');        $Page->setConfig('prev','上一页');        $Page->setConfig('next','下一页');        $Page->setConfig('last','末页');        $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END% ');        $Page->lastSuffix = false;//分页最后的总页数不显示		$show = $Page->show();// 分页显示输出		// 进行分页数据查询 注意limit方法的参数要使用Page类的属性		$list = $User->order('store_id')->limit($Page->firstRow.','.$Page->listRows)->select();		$this->assign('list',$list);// 赋值数据集		$this->assign('page',$show);// 赋值分页输出		$this->meta_title = '菜品销量设置';		$this->display(); // 输出模板    }    //获取菜品    public function get_canpin(){        $store_id = I("sid");        $User = M('canming');        $data['store_id']= $store_id;        $list = $User->where($data)->select();        $this->ajaxReturn($list);    }    //设置菜品销量    public function set_number(){        $cai_id = I("cai_id"); //菜品id        $s_id = I("s_id");  //商家id        $min_val = I("min_val");        $max_val = I("max_val");        $type = I("ctype");        $nian = I("cnian");        $yue = I("cyue");        //type等于2是单个修改        if($type == 2){            if($min_val == -1){                $qi = 1;            }else{                $qi = $min_val;            }            if($max_val == -1){                $zi = 100;            }else{                $zi = $max_val;            }            $sj_num = rand($qi,$zi);            $User = M('goods_count_number');            $data['cm_id'] = $cai_id;            $data['store_id'] = $s_id;            $ret = $User->where($data)->find();            $data['quantity'] = $sj_num;            $data['year'] = $nian;            $data['month'] = $yue;            if($ret == null){                $ret_tr = $User->add($data);                if($ret_tr >0 ){                    $this->ajaxReturn("1");                }else{                    $this->ajaxReturn("0");                }            }else{                $dc['count_id'] = $ret['count_id'];                $ret_tr = $User->where($dc)->save($data);                if($ret_tr >0 ){                    $this->ajaxReturn("1");                }else{                    $this->ajaxReturn("0");                }            }        }else{            $CanMing = M('canming');            $data['store_id'] = $s_id;            $ret_sel = $CanMing->where($data)->select();            if($ret_sel != null){                foreach($ret_sel as $s1){                    $dd = null;                    if($min_val == -1){                        $qi = 1;                    }else{                        $qi = $min_val;                    }                    if($max_val == -1){                        $zi = 100;                    }else{                        $zi = $max_val;                    }                    $sj_num = rand($qi,$zi);                    $User = M('goods_count_number');                    $dd['cm_id'] = $s1['cm_id'];                    $dd['store_id'] = $s_id;                    $ret = $User->where($dd)->find();                    $dd['quantity'] = $sj_num;                    $dd['year'] = $nian;                    $dd['month'] = $yue;                    if($ret == null){                        $User->add($dd);                    }else{                        $dc['count_id'] = $ret['count_id'];                        $User->where($dc)->save($dd);                    }                }                $this->ajaxReturn("1");            }else{                $this->ajaxReturn("0");            }        }    }}