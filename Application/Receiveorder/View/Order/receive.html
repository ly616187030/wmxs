<extend name="./Application/Admin/View/Public/layout.html"/><block name="style">    <style>        body{            padding:20px;            font-family: "Microsoft Yahei";        }    </style></block><block name="main">    <div><button id="stop" class="btn btn-default glyphicon glyphicon-pause" type="button">停止提示铃声</button></div>    <audio src="__PUBLIC__/audio.mp3" preload="auto" id="audio"></audio>    <hr/>    <div id="id_wudan">        <notempty name="list">            <volist name="list" id="_data">                <div class="panel panel-primary " id="ord_{$_data.order_id}">                    <div class="panel-heading">                        <h3 class="panel-title"><span>订单号：{$_data.order_sn}</span><span style="padding-left:30px">餐厅:{$_data.store_name}</span><span style="padding-left:30px">餐厅距送餐地址约:<span style="color:#ffff00;font-size:1.2em">{$_data.distance}</span>米</span></h3>                    </div>                    <div class="panel-body">                        <table class="table ">                            <tr >                                <th>餐名</th>                                <th>单价</th>                                <th>份数</th>                                <th>金额</th>                                <th>支付方式</th>                                <th>送餐时间</th>                                <th>下单时间</th>                            </tr>                            <notempty name="_data.detail">                                <volist name="_data.detail" id="_d">                                    <tr class="success">                                        <td>{$_d.cm_name}</td>                                        <td>{$_d.price}元</td>                                        <td>{$_d.quantity}份</td>                                        <td>{$_d['price']*$_d['quantity']}元</td>                                        <td><if condition="($_data.pay_type eq 1)">在线支付<else />货到付款</if></td>                                        <td>                                            {$_data.send_time|date='Y-m-d H:i:s',###}                                        </td>                                        <td>{$_d.xd_time|date='Y-m-d H:i:s',###}</td>                                    </tr>                                </volist>                            </notempty>                            <tr style='color:#FF2D4B;'><td>菜品总价</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>{$_data.total}元</td></tr>                            <tr style='color:#FF2D4B;'><td>返点金额</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>{$_data['total']*$_data['store_rebate']/100|round}元</td></tr>                            <tr style='color:#FF2D4B;'><td>减去返点后价格</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>{$_data['total']-($_data['total']*$_data['store_rebate']/100)|round}元</td></tr>                            <tr style='color:#FF2D4B;'><td>用餐人数</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>{$_data.people_num}人</td></tr>                        </table>                        <div class="orderlist">                            <label class="text-info glyphicon glyphicon-user"><strong>姓名：{$_data.username}</strong></label>                            &nbsp;&nbsp;&nbsp;                            <label class="text-info glyphicon glyphicon-phone"><strong>电话：{$_data.phone}</strong></label>                            &nbsp;&nbsp;&nbsp;                            <label class="text-info glyphicon glyphicon-home"><strong>地址：{$_data.detail_address}</strong></label>                            &nbsp;&nbsp;&nbsp;                            <label class="text-info glyphicon glyphicon-volume-up"><strong>客户留言：{$_data.order_message}</strong></label>                        </div>                        <div style="float:right;position:absolute; position: relative;"  >                            <label class="text-danger"><strong style="font-size: 1.2em">￥{$_data['total']-($_data['total']*$_data['store_rebate']/100)|round}元</strong></label>                            &nbsp;&nbsp;                            <button class="btn btn-return bt_jiedan" data-shmode="{$_data.sh_mode}" data-pushid="{$_data.push_msg_id}" data-orderid="{$_data.order_id}" data-storeid="{$_data.store_id}" data-status="{$_data.pay_type}" data-ordersn="{$_data.order_sn}" >接单</button>                            <button class="btn submit-btn bt_jujie"   style=" cursor:pointer;"  data-paytype="{$_data.pay_type}"  data-orderid="{$_data.order_id}" data-pushid="{$_data.push_msg_id}" data-ordersn="{$_data.order_sn}">拒接</button>                        </div>                    </div>                </div>            </volist>            <else/>            <empty name="pd_dp">                <h1 align='center'><span class='label label-default'> aOh! 暂时还没有订单!</span></h1><div>&nbsp;</div>                <else />                <h1 align='center'><span class='label label-default'> {$pd_dp}</span></h1><div>&nbsp;</div>            </empty>        </notempty>    </div>    <div id="alert_tip" style="background: rgba(0,0,0,.6);position: absolute;top:35%;left:50%;z-index:9999;font-size:2.0em;padding:10px 20px;color:#fff;border-radius: 5px;font-weight:bold;display: none;">接单成功！</div></block><block name="script">    <script src='__PUBLIC__/socket.io.js'></script>    <script type="text/javascript">        $(document).ready(function () {            var storelist="{$_storestr}";            var curr='{$curr}';            var uid='{:session("user_auth.push_msg_id")}';            // 连接服务端            //var socket = io('http://'+document.domain+':2120');            var socket = io('http://zhg.zhuyousoft.com:2120');            // 连接后登录            socket.on('connect', function(){                socket.emit('login', uid);            });            // 后端推送来消息时            socket.on('new_msg', function(msg){                //$('#content').html('收到消息：'+msg);                msg=='success' && get_list();                playaudio();                //msg=='success' && location.reload();            });            // 推送信息响铃            //get_list();            var music=document.getElementById('audio');            var stop=document.getElementById('stop');            var timer;            function playaudio(){                timer=setInterval(function(){                    music.play();                },2000);            }            stop.onclick=function(){                music.pause();                clearInterval(timer);            }        });        var peisong="{:C('PS_QUANTITY')}";        $("#id_wudan").on("click",".bt_jiedan", function () {            $('#stop').trigger('click');            var th = $(this);            var store_id = parseInt(th.data("storeid"));            var status = th.data("status");            var ord_id = th.data("orderid");            var shmode=th.data("shmode");            var ordersn=th.data('ordersn');            var pushid=th.data('pushid');            $.post("{:U('peiSong')}","storeid="+store_id+"&shmode="+shmode).success(function(data){                //自己配送，有配送员                if(data.status==1){                    var data=data.list;                    $(".modal-content").empty();                    $(".modal-content").html("<div class='modal-header'></div><div class='modal-body' style='min-height: 100px;'></div>");                    $(".modal-header").html("<h4><strong>选择配送员</strong></h4>");                    $(".modal-body").html("" +                    "<form action='{:U('setPeisong')}' method='post' class='form-horizontal'><table class='table' id='peisong_tb'>" +                    "<thead><tr><th>配送员</th><th>当前送餐数量</th><th>所属</th></tr></thead>" +                    "<tbody></tbody></table>" +                    "<input type = 'hidden' value='"+ord_id+"' name='order_id' /><input type='hidden' name=\"store_id\" value=\""+store_id+"\"/><div class='modal-footer'></div>");                    for(var i= 0,ll=data.length;i<ll;i++){                        var def,def_str,warning,fromto,fselected;                        if(data[i].count==undefined) data[i].count=0;                        data[i].count>=parseInt(peisong)?(warning="<b style='color:red'>"+data[i].count+"</b>"):(warning=data[i].count);                        data[i].default_rst==store_id?def="checked":(i==0?def="checked":def="");                        data[i].default_rst==store_id?def_str="<b style='color:red;font-weight: bold;padding-left:20px;'>默认</b>":def_str="";                        data[i].is_who==0?fromto="商家":fromto="平台";                        var a = "<tr><td><div class='radio'><input type='radio' name='person_id' value='"+data[i].person_id+"'"+def+" />"+data[i].person_name+def_str+"</div></td><td><div class='col-sm-2'>"+warning+"</div> </td><td>"+fromto+"</td></tr>"                        $("#peisong_tb tbody").append(a);                    }                    $(".modal-footer").html("<button type='button' class='btn btn-return ajax-post' id='submits' target-form=\"form-horizontal\">确定</button><button type='button' class='btn submit-btn' data-dismiss='modal'>取消</button></form>");                    $("#myModal").modal("show");                    $("#submits").click(function(){                        var pid=$("input[name='person_id']").val();                        $.get("{:U('setPeisong')}","order_id="+ord_id+"&store_id="+store_id+"&person_id="+pid+"&sh_mode=1&ordersn="+ordersn+"&pushid="+pushid).success(function(){                            //location.reload();                            alert_tip('成功接单,等待配送!',ord_id);                            $("#myModal").modal("hide");                        });                    });                    //配送点击实现                    $("#peisong_tb tbody").on("click","tr",function(){                        var $this=$(this);                        $this.find("input[type='radio']").prop("checked",true);                    });                }else if(data.status==0){                    //平台配送                    $.get("{:U('setPeisong')}","order_id="+ord_id+'&ordersn='+ordersn+'&pushid='+pushid).success(function(data){                        alert_tip('成功接单,等待平台配送!',ord_id);                    });                }else if(data.status==2){                    //自己配送，没有配送员                    $.get("{:U('setPeisong')}","order_id="+ord_id+"&sh_mode=1&ordersn="+ordersn+'&pushid='+pushid).success(function(){                        //location.reload();                        alert_tip('成功接单!',ord_id);                    });                }            });        }).on("click",".bt_jujie",function () {            var th = $(this);            var id = th.data("orderid");            var pushid=th.data('pushid');            var paytype=th.data('paytype');            $("#myModal").modal("show").find(".modal-title").text('拒单理由').end().find('.modal-body').html('<textarea  class="form-control" row="3" id="reject_text" placeholder="输入拒接理由"></textarea>')                    .end().find('.modal-footer').html('<button class="btn btn-default" id="real_do">确定</button>');            $("#real_do").click(function(){                var reject=$("#reject_text").val();                $('#myModal').modal('hide');                $.post("{:U('setReject')}",{id:id,reject_reason:reject,paytype:paytype,pushid:pushid}).success(function(data){                    alert_tip('商家已拒单!',id);                });            });        });        //添加定时器自动获取订单        function get_list(){            var storelist='{$_storestr}';            $.get("{:U('Order/receive')}","type=1&ordid="+storelist).success(function(data1){                //console.log(data1);                var strs="";                var planstr='';                var pdl='padding-left:30px;';                for(var i= 0,ln=data1.length;i<ln;i++){                    strs+="<div class=\"panel panel-primary \" id=\"ord_"+data1[i].order_id+"\"><div class=\"panel-heading\">" +                    "<h3 class=\"panel-title\"><span>订单号："+data1[i].order_sn+"</span><span style="+pdl+">餐厅:"+data1[i].store_name+"</span><span style="+pdl+">餐厅距送餐地址约:<span style=\"color:#ffff00;font-size:1.2em\">"+data1[i].distance+"</span>米</span></h3></div>" +                    "<div class=\"panel-body\"><table class=\"table table-striped\"><tbody><tr> <th>菜名</th> <th>单价</th> <th>份数</th> <th>金额</th><th>支付方式</th> <th>送餐时间</th> <th>下单时间</th></tr>";                    var detail=data1[i].detail;                    var paytype,sendtime;                    data1[i].pay_type==0?paytype="货到付款":paytype="在线支付";                    var xdtime=data1[i].xd_time;                    var substrs="";                    for(var j= 0,detail_l=detail.length;j<detail_l;j++){                        var total=parseInt(detail[j].price)*parseInt(detail[j].quantity);                        substrs+="<tr class='success'><td>"+detail[j].cm_name+"</td><td>"+detail[j].price+"元</td><td>"+detail[j].quantity+"份</td><td>"+total+"</td><td>"+paytype+"</td><td>"+data1[i].send_time_to+"</td><td>"+xdtime+"</td></tr>";                    }                    strs+=substrs;                    strs+="<tr style='color:#FF2D4B;'><td>菜品总价</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>"+data1[i].total+"元</td></tr><tr style='color:#FF2D4B;'><td>返点金额</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>"+(data1[i].total)*(data1[i].store_rebate)/100+"元</td></tr><tr style='color:#FF2D4B;'><td>减去返点后价格</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>"+(data1[i].total-(data1[i].total)*(data1[i].store_rebate)/100)+"元</td></tr><tr style='color:#FF2D4B;'><td>用餐人数</td><td>&nbsp;</td><td>&nbsp;</td><td colspan='4'>"+data1[i].people_num+"人</td></tr>";                    strs+="</tbody></table><div class=\"orderlist\"><label class=\"text-info glyphicon glyphicon-user\"><strong>姓名："+data1[i].username+"</strong></label> " +                    "<label class=\"text-info glyphicon glyphicon-phone\"><strong>电话："+data1[i].phone+"</font></strong></label> " +                    "<label class=\"text-info glyphicon glyphicon-home\"><strong>地址："+data1[i].detail_address+"</strong></label>&nbsp;&nbsp;<label class=\"text-info glyphicon glyphicon-volume-up\"><strong>客户留言："+data1[i].order_message+"</strong></label></div><div style=\"float:right;position:absolute; position: relative;\"  >" +                    "<label class=\"text-danger\"><strong style='font-size:1.2em;padding-right:20px;'>￥"+(data1[i].total-(data1[i].total)*(data1[i].store_rebate)/100)+"元</strong></label>"+                    "<button class=\"btn btn-return bt_jiedan\" data-shmode=\""+data1[i].sh_mode+"\" data-pushid=\""+data1[i].push_msg_id+"\"  data-orderid=\""+data1[i].order_id+"\" data-storeid=\""+data1[i].store_id+"\" data-status=\""+data1[i].pay_type+"\"  data-ordersn=\""+data1[i].order_sn+"\">接单</button> " +                    "<button class=\"btn submit-btn bt_jujie\"   style=\" cursor:pointer;\" data-pushid=\""+data1[i].push_msg_id+"\" data-paytype=\""+data1[i].pay_type+"\"  data-orderid=\""+data1[i].order_id+"\">拒接</button> </div></div></div>";                }                $("#id_wudan").empty().append(strs);            });        }        function alert_tip(text,ordid){            var tip=$("#alert_tip")            tip.text(text).show();            setTimeout(function(){                tip.hide("fast",'linear');                $("#ord_"+ordid).hide();            },1000)        }    </script></block>