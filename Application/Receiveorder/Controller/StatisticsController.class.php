<?php/** * Created by PhpStorm. * User: Administrator * Date: 2015/8/10 0010 * Time: 下午 4:28 */namespace Receiveorder\Controller;use Admin\Controller\AdminController;class StatisticsController extends AdminController{    public function index(){            $store=M("restaurant_allot")->where("uid=".UID)->find();          $store_id = explode(',',$store['store_id']);          $store_name = explode(',',$store['store_name']);        for($i=0;$i<count($store_id);$i++){        $stores[] =array('store_id'=>$store_id[$i],'store_name'=>$store_name[$i]);}        if($_GET) {            $aaa = I('get.');            $rstid = intval($aaa['restaurant']);            $stime = $aaa['stime'];            $etime = $aaa['etime'];            $stime = empty($stime) ? '' : strtotime($stime);            $etime = empty($etime) ? '' : strtotime($etime);            $map['complete_time'] = array(array('gt', $stime), array('elt', $etime));            $map['store_id'] = $rstid;            $data = M("Order")->where($map)->select();            $this->ajaxReturn($data);        }else{            $map['store_id']=$store_id[0];;            $data = M("Order")->where($map)->select();        }        $this->assign("_list",$data);        $this->assign("_store",$stores);        $this->assign("listtt",0);        $this->assign("_bootstrap",1);        $this->meta_title='统计';        $this->display();    }    public function getTongjiFromRst(){        $rstid=I('restaurant');        $stime=I('stime');        $etime=I('etime');        $stime=empty($stime)?time():strtotime($stime);        $etime=empty($etime)?time():strtotime($etime);        $map['xd_time']=array(array('gt',$stime),array('lt',$etime));        $map['store_id']=$rstid;        $data=M("Order")->where($map)->select();        $this->ajaxReturn(empty($data)?null:$data);        //$this->ajaxReturn(M("Order")->_sql());        //$this->ajaxReturn(array(array('a'=>'abcd'),array("a"=>'22222')));    }    public function completion(){        $store=M("restaurant_allot")->where("uid=".UID)->find();        $store_id = explode(',',$store['store_id']);        $store_name = explode(',',$store['store_name']);        for($i=0;$i<count($store_id);$i++){            $stores[] =array('store_id'=>$store_id[$i],'store_name'=>$store_name[$i]);}        if($_GET){            $aaa = I('get.');            $rstid=intval($aaa['restaurant']);            $stime=$aaa['stime'];            $etime=$aaa['etime'];            $stime=empty($stime)?'':strtotime($stime);            $etime=empty($etime)?'':strtotime($etime);            $map['complete_time']=array(array('gt',$stime),array('elt',$etime));            $map['store_id']=$rstid;            $data=M("Order")->where($map)->field("order_sn,status,ps_cost,yh_price,total,complete_time,pay_type")->select();            $qtime = M("Order")->where($map)->field("complete_time")->group('complete_time')->select();            foreach($qtime as $kk=>$vv) {                $time = date('Y-m-d', $vv['complete_time']);                $cnum=0;                $qnum=0;                $tnum=0;                $jnum=0;                $cm=0;$qm=0;$tm=0;$jm=0;                foreach($data as $k=>$v){                    $times = date('Y-m-d',$v['complete_time']);                    if ($time == $times) {                        if ($v['status'] == 5 || $v['status'] == 6) {                            $cnum += count($v['status']);                            $cm += $v['total'];                        } elseif ($v['status'] == 7 || $v['status'] == 13) {                            $qnum += count($v['status']);                            $qm += $v['total'];                        } elseif ($v['status'] == 12) {                            $tnum += count($v['status']);                            $tm += $v['total'];                        } elseif ($v['status'] == 9) {                            $jnum += count($v['status']);                            $jm += $v['total'];                        };                    }                }                $msg[] =  array('c' => $cnum,'cm'=>$cm, 'q' => $qnum,'qm'=>$qm, 't' => $tnum,'tm'=>$tm, 'j' => $jnum,'jm'=>$jm,'time'=>$time);            }$this->ajaxReturn($msg);        }else{            $map['store_id']=$store[0];            $data=M("Order")->where($map)->field("order_sn,status,ps_cost,yh_price,total,complete_time")->select();            $qtime = M("Order")->where($map)->field("complete_time")->group('complete_time')->select();                foreach($qtime as $kk=>$vv) {                    $time = date('Y-m-d', $vv['complete_time']);                    $cnum=0;                    $qnum=0;                    $tnum=0;                    $jnum=0;                    $cm=0;$qm=0;$tm=0;$jm=0;                    foreach($data as $k=>$v){                        $times = date('Y-m-d',$v['complete_time']);                    if ($time == $times) {                        if ($v['status'] == 5 || $v['status'] == 6) {                            $cnum += count($v['status']);                            $cm += $v['total'];                        } elseif ($v['status'] == 7 || $v['status'] == 13) {                            $qnum += count($v['status']);                            $qm += $v['total'];                        } elseif ($v['status'] == 12) {                            $tnum += count($v['status']);                            $tm += $v['total']*$tnum;                        } elseif ($v['status'] == 9) {                            $jnum += count($v['status']);                            $jm += $v['total'];                        };                    }                    }                    $msg[] =  array('c' => $cnum,'cm'=>$cm, 'q' => $qnum,'qm'=>$qm, 't' => $tnum,'tm'=>$tm, 'j' => $jnum,'jm'=>$jm,'time'=>$time);                }        }        $this->assign('msg',$msg);        $this->assign("_store",$stores);        $this->assign("listtt",0);        $this->assign("_bootstrap",1);        $this->meta_title='统计';        $this->display();    }    function today(){        $store=M("restaurant_allot")->where("uid=".UID)->find();        $store_id = explode(',',$store['store_id']);        $store_name = explode(',',$store['store_name']);        for($i=0;$i<count($store_id);$i++){            $stores[] =array('store_id'=>$store_id[$i],'store_name'=>$store_name[$i]);}        $title = "今日数据统计 ";        $this->assign('title', $title);        $dtime = date('Y.m.d', NOW_TIME);/*本周一结束时间*/        $this->assign('dtime', $dtime);        /*销售统计*/        if($_GET){            $store_id =$_GET['store_id'];            $canpin = M('canpin')->where("store_id = $store_id")->select();            $this->ajaxReturn($canpin);        }        else if($_POST){            $store_id = $_POST['store_id'];            $cp_id = $_POST['cp_id'];            if($cp_id==0){                $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')                    ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')                    ->where("o.total!=''AND o.store_id = $store_id")                    ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')                    ->select();                $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where('wm_canming.store_id='.$store_id)->group('cm_name')->field('cm_name')->select();            }else{                $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')                    ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')                    ->where("o.total!=''AND o.store_id = $store_id AND m.canping_id = $cp_id")                    ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')                    ->select();                $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where("wm_canming.store_id=$store_id AND wm_canming.canping_id=$cp_id")->group('cm_name')->field('cm_name')->select();            }            $qtime = NOW_TIME;            foreach($canm as $k=>$v){                $num = 0;                $goods=array();                $ztotal=0;                $znum=0;                foreach ($order as $n => $val) {                    $dtime = $val['dxd_time'];                    $otime = $val['oxd_time'];                    $a = date('Y-m-d', $qtime);/*格式时间戳为 20141024*/                    $b = date('Y-m-d',$dtime);                    $c = date('Y-m-d',$otime);                    if ($a == $b&&$a == $c&&$val['cm_name']==$v['cm_name']) {//当天                        $num += $val['quantity'];                        $goods= array('cm_name'=>$val['cm_name'],'num'=>$num,'price'=>$val['price'],'total'=>$num*$val['price'],'time'=>$val['oxd_time']);                    }                    if($a == $b&&$a == $c){                        $znum += $val['quantity'];                        $ztotal +=$val['total_money'];                    }                }                $agood[]=$goods;            }            $this->ajaxReturn(array('agood'=>$agood,'znum'=>$znum,'ztotal'=>$ztotal));        }        else{            $store_id = $store_id[0];            $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')                ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')                ->where("o.total!=''AND o.store_id = $store_id")                ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')                ->select();            $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where('wm_canming.store_id='.$store_id)->group('cm_name')->field('cm_name')->select();            $qtime = NOW_TIME;            foreach($canm as $k=>$v){                $num = 0;                $goods=array();                $ztotal=0;                $znum=0;            foreach ($order as $n => $val) {                $dtime = $val['dxd_time'];                $otime = $val['oxd_time'];                $a = date('Y-m-d', $qtime);                $b = date('Y-m-d',$dtime);                $c = date('Y-m-d',$otime);                if ($a == $b&&$a == $c&&$val['cm_name']==$v['cm_name']) {//当天                    $num += $val['quantity'];                    $goods= array('cm_name'=>$val['cm_name'],'num'=>$num,'price'=>$val['price'],'total'=>$num*$val['price'],'time'=>$val['oxd_time']);                }                if($a == $b&&$a == $c){                $znum += $val['quantity'];                $ztotal +=$val['total_money'];                }            }                $agoods[]=$goods;            }        }        $this->assign('znum',$znum);        $this->assign('ztotal',$ztotal);        $this->assign("_store",$stores);        $this->assign('goods',$agoods);        $this->display();    }    function week(){        $store=M("restaurant_allot")->where("uid=".UID)->find();        $store_id = explode(',',$store['store_id']);        $store_name = explode(',',$store['store_name']);        for($i=0;$i<count($store_id);$i++){            $stores[] =array('store_id'=>$store_id[$i],'store_name'=>$store_name[$i]);}        $time = time();        $w_day=date("w",$time);        if($w_day=='1'){            $cflag = '+0';        }        else {            $cflag = '-1';        }        //本周一零点的时间戳        $start_time = strtotime(date('Y-m-d',strtotime("$cflag week Monday", $time)));        //本周末零点的时间戳        $stop_time = strtotime(date('Y-m-d',strtotime("$cflag week Monday", $time)))+7*24*3600;        $this->meta_title = '管理首页';        $title="本周数据统计 ";        $q=date('Y-m-d H:i:s',$start_time);/*本周一零点格式时间戳为20141020000000*/        $b=date('Y-m-d H:i:s', $stop_time);/*本周末格式时间戳为201410270000000*/        $stime=date('Y.m.d H:i:s',$start_time);/*本周一开始时间*/        $etime=date('Y.m.d H:i:s',$stop_time);/*本周一结束时间*/        $this->assign('title',$title);        /*销售统计*/        if($_GET){            $store_id =$_GET['store_id'];            $canpin = M('canpin')->where("store_id = $store_id")->select();            $this->ajaxReturn($canpin);        }elseif($_POST){            $store_id = $_POST['store_id'];            $cp_id = $_POST['cp_id'];            if($cp_id==0){                $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')                    ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')                    ->where("o.total!=''AND o.store_id = $store_id")                    ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')                    ->select();                $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where('wm_canming.store_id='.$store_id)->group('cm_name')->field('cm_name')->select();            }else{                $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')                    ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')                    ->where("o.total!=''AND o.store_id = $store_id AND m.canping_id = $cp_id")                    ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')                    ->select();                $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where("wm_canming.store_id=$store_id AND wm_canming.canping_id=$cp_id")->group('cm_name')->field('cm_name')->select();            }            foreach($canm as $k=>$v){                $num = 0;                $goods=array();                $znum =0;                $ztotal=0;                foreach ($order as $n => $val) {                    $dtime = date('Y-m-d H:i:s',$val['dxd_time']);                    if ($b > $dtime&&$dtime > $q&&$val['cm_name']==$v['cm_name']) {//当天                        $num += $val['quantity'];                        $goods= array('cm_name'=>$val['cm_name'],'num'=>$num,'price'=>$val['price'],'total'=>$num*$val['price'],'time'=>array('s'=>$stime,'e'=>$etime));                    }                    if($b > $dtime&&$dtime > $q){                        $znum += $val['quantity'];                        $ztotal +=$val['total_money'];                    }                }                $agood[]=$goods;            }            $this->ajaxReturn(array('agood'=>$agood,'znum'=>$znum,'ztotal'=>$ztotal));        }else{        $store_id = $store_id[0];        $order = M("order_detail")->alias('d')->join('LEFT JOIN wm_order o ON o.order_id = d.order_id')            ->join('LEFT JOIN wm_canming m ON m.cm_id = d.cm_id')            ->where("o.total!=''AND o.store_id = $store_id")            ->field('m.cm_name,d.cm_id,d.price,d.quantity,d.xd_time as dxd_time,d.total_money,o.xd_time as oxd_time')            ->select();        $canm = M('canming')->join('RIGHT JOIN wm_order_detail ON wm_canming.cm_id = wm_order_detail.cm_id')->where('wm_canming.store_id='.$store_id)->group('cm_name')->field('cm_name')->select();        foreach($canm as $k=>$v){            $num = 0;            $goods=array();            $znum =0;            $ztotal=0;            foreach ($order as $n => $val) {                $dtime = date('Y-m-d H:i:s',$val['dxd_time']);                if ($b > $dtime&&$dtime > $q&&$val['cm_name']==$v['cm_name']) {//当天                    $num += $val['quantity'];                    $goods= array('cm_name'=>$val['cm_name'],'num'=>$num,'price'=>$val['price'],'total'=>$num*$val['price'],'time'=>array('s'=>$stime,'e'=>$etime));                }                if($b > $dtime&&$dtime > $q){                $znum += $val['quantity'];                $ztotal +=$val['total_money'];                }            }            $agoods[]=$goods;        }        }        $this->assign('znum',$znum);        $this->assign('ztotal',$ztotal);        $this->assign("_store",$stores);        $this->assign('goods',$agoods);        $this->display();    }}